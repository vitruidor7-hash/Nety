<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniSocial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple animation for new posts */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Style for a liked button */
        .liked-button {
            color: #EF4444; /* red-500 */
        }
        .liked-button svg {
            fill: #EF4444;
        }

        /* Active state for bottom nav */
        .bottom-nav-link.active {
            color: #4F46E5; /* indigo-600 */
        }
        
        /* NEW: Active state for filter tabs */
        .filter-link.active {
            border-color: #4F46E5; /* indigo-600 */
            background-color: #EEF2FF; /* indigo-50 */
            color: #4338CA; /* indigo-700 */
            font-weight: 600;
        }

        /* Mobile message UI layout control */
        @media (max-width: 767px) {
            /* By default, show the list */
            #content-messages.mobile-chat-list #dm-list-container {
                display: flex;
            }
            #content-messages.mobile-chat-list #dm-chat-container,
            #content-messages.mobile-chat-list #dm-placeholder-container {
                display: none;
            }

            /* When in chat view, show the chat */
            #content-messages.mobile-chat-view #dm-list-container {
                display: none;
            }
            #content-messages.mobile-chat-view #dm-chat-container {
                display: flex;
            }
            #content-messages.mobile-chat-view #dm-placeholder-container {
                display: none;
            }
        }
    </style>
<style>.meta-counts{display:none !important;}</style>
</head>
<body class="bg-slate-100 font-sans">

    <!-- Auth Container -->
    <div id="auth-container" class="container mx-auto max-w-md p-6 mt-10 md:mt-20 bg-white rounded-lg shadow-xl">
        <div id="auth-error" class="text-red-600 text-sm mb-4" role="alert"></div>
        <h1 class="text-4xl font-bold text-indigo-600 text-center mb-6">MiniSocial</h1>
        
        <form id="signup-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Create Account</h2>
            <div>
                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Sign Up</button>
        </form>

        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/f lg:w-1/4"></span>
        </div>

        <form id="login-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Log In</h2>
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-200">Log In</button>
        </form>
        
        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/5 lg:w-1/4"></span>
        </div>

        <button id="google-signin" class="w-full flex items-center justify-center space-x-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            <span>Sign in with Google</span>
        </button>
    </div>

    <!-- Username Modal -->
    <div id="username-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4">Create your profile</h2>
            <p class="text-gray-600 mb-4">You need a unique username to continue.</p>
            <div id="username-error" class="text-red-600 text-sm mb-4" role="alert"></div>
            <form id="username-form">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">@</span>
                        <input type="text" id="username-input" required placeholder="your_username" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300">
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Save and Enter</button>
            </form>
        </div>
    </div>

    <!-- NEW: Account Deletion Modal -->
    <div id="delete-account-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Delete Account</h2>
            <p class="text-gray-600 mb-4">Are you sure you want to delete your account? This action is permanent and cannot be undone. All your profile data will be removed.</p>
            <div id="delete-error" class="text-red-600 text-sm mb-4" role="alert"></div>
            <!-- Reauthentication Section (shown only if needed) -->
            <div id="reauth-section" class="hidden space-y-3 border-t pt-4 mt-4">
                <p id="reauth-hint" class="text-sm text-gray-700">For security, please reauthenticate and try again.</p>
                <div id="reauth-password-container" class="space-y-2 hidden">
                    <label for="reauth-password-input" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                    <input id="reauth-password-input" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your password">
                    <button id="reauth-password-btn" class="w-full bg-slate-800 text-white font-semibold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-200">Reauthenticate with Password</button>
                </div>
                <button id="reauth-google-btn" class="hidden w-full flex items-center justify-center space-x-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    <span>Reauthenticate with Google</span>
                </button>
                <button id="retry-delete-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-full hover:bg-red-700 transition duration-200">Retry Delete</button>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-200">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full hover:bg-red-700 transition duration-200">
                    Confirm Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden container mx-auto max-w-7xl p-4 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Sidebar (Desktop-only) -->
        <aside class="hidden md:block md:col-span-1 md:sticky top-6 h-screen">
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-6">
                <h1 class="text-3xl font-bold text-indigo-600">MiniSocial</h1>

                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" data-target="content-home" class="nav-link flex items-center space-x-3 text-lg font-semibold text-gray-800 p-2 rounded-lg bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-discover" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 10V7m0 10l-6-3" /></svg>
                                <span>Discover</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-link-profile" data-target="content-profile" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-messages" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                <span>Messages</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-settings" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <button id="sidebar-post-button" class="w-full bg-indigo-600 text-white font-bold text-lg py-3 rounded-full hover:bg-indigo-700 transition duration-200">
                    Post
                </button>

                <div class="border-t pt-4 mt-6">
                    <div id="sidebar-profile-button" class="flex items-center space-x-3 cursor-pointer rounded-lg p-2 -ml-2 hover:bg-slate-100">
                        <img id="user-avatar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <div>
                            <p id="user-displayname" class="font-semibold text-gray-800">Your Name</p>
                            <p id="user-handle" class="text-sm text-gray-500">@yourhandle</p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full mt-4 text-sm text-center text-gray-600 hover:text-indigo-600">Log Out</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="col-span-1 md:col-span-2 space-y-6 pb-20 md:pb-0">

            <!-- Home Panel -->
            <div id="content-home" class="content-panel space-y-6">
                <!-- Hide post box on mobile, it's replaced by the new post panel -->
                <div class="bg-white p-4 rounded-lg shadow-sm hidden md:block">
                    <div class="flex items-start space-x-3">
                        <img id="post-user-avatar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <textarea id="post-textarea" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="What's happening?"></textarea>
                    </div>
                    <div id="post-error" class="text-red-600 text-sm mt-2 text-right" role="alert"></div>
                    <div class="flex justify-end mt-3">
                        <button id="post-button" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                            Post
                        </button>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 px-2 md:px-0">Your Home Feed</h2>
                <div id="feed-container-home" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="home-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Discover Panel -->
            <div id="content-discover" class="content-panel hidden space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800">Discover All Posts</h2>
                    
                    <!-- NEW: Filter dropdown -->
                    <div class="mt-4">
                        <label for="discover-filter-select" class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                        <select id="discover-filter-select" class="w-full md:w-auto border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="new">New</option>
                            <option value="popular">Popular</option>
                            <option value="likes">Most Likes</option>
                            <option value="comments">Most Comments</option>
                        </select>
                    </div>
                </div>

                <div id="feed-container-discover" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="discover-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Profile Panel -->
            <div id="content-profile" class="content-panel hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <img id="profile-page-avatar" src="https://placehold.co/80x80/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
                            <div>
                                <h2 id="profile-page-username" class="text-3xl font-bold text-gray-900">Username</h2>
                                <p id="profile-page-handle" class="text-lg text-gray-500">@handle</p>
                            </div>
                        </div>
                        <button id="profile-follow-button" class="hidden mt-4 sm:mt-0 w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-200">
                            Follow
                        </button>
                    </div>
                    <div class="flex space-x-6 mt-6 border-t pt-4">
                        <div>
                            <span id="profile-following-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Following</span>
                        </div>
                        <div>
                            <span id="profile-followers-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Followers</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="font-medium">User ID:</p>
                        <p id="profile-page-uid" class="text-gray-500 text-sm break-all"></p>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Posts</h3>
                <div id="profile-feed-container" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="profile-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Messages Panel -->
            <div id="content-messages" class="content-panel hidden bg-white rounded-lg shadow-sm h-screen md:h-[80vh] mobile-chat-list">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    
                    <div id="dm-list-container" class="md:col-span-1 border-r border-gray-200 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 p-4 border-b">Conversations</h2>
                        <div id="dm-conversation-list" class="flex-1 overflow-y-auto">
                            <p class="p-4 text-gray-500">Loading conversations...</p>
                        </div>
                    </div>
                    
                    <div id="dm-chat-container" class="md:col-span-2 h-full flex flex-col hidden">
                        <div id="dm-chat-header-bar" class="flex items-center p-4 border-b">
                            <button id="dm-back-btn" class="md:hidden p-1 mr-2 text-gray-600 hover:text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 id="dm-chat-header" class="text-xl font-semibold text-gray-800">Select a conversation</h2>
                        </div>
                        
                        <div id="message-log" class="flex-1 p-4 space-y-4 overflow-y-auto bg-slate-50">
                        </div>
                        
                        <form id="dm-form" class="p-4 border-t flex space-x-3 bg-white">
                            <input type="text" id="dm-input" placeholder="Select a conversation to message..." class="flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" disabled>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200" disabled>Send</button>
                        </form>
                    </div>

                    <div id="dm-placeholder-container" class="md:col-span-2 h-full md:flex items-center justify-center bg-slate-50 hidden">
                         <p class="text-gray-500">Select a conversation to start chatting.</p>
                    </div>

                </div>
            </div>

            <!-- Full-screen Post Panel (for mobile) -->
            <div id="content-post" class="content-panel hidden space-y-4 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">New Post</h2>
                    <button id="post-cancel-button" class="text-gray-600 hover:text-indigo-600 font-medium">Cancel</button>
                </div>
                <div class="flex items-start space-x-3">
                    <img id="post-panel-user-avatar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <textarea id="post-panel-textarea" class="w-full p-2 text-lg border-0 rounded-lg focus:outline-none focus:ring-0" rows="8" placeholder="What's happening?"></textarea>
                </div>
                <div id="post-panel-error" class="text-red-600 text-sm mt-2 text-right" role="alert"></div>
                <div class="flex justify-end mt-3">
                    <button id="post-panel-button" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                        Post
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="content-settings" class="content-panel hidden bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
                
                <div class="space-y-4">
                    <div>
                        <p class="font-medium">Your Email:</p>
                        <p id="settings-email" class="text-gray-700"></p>
                    </div>
                    <div>
                        <p class="font-medium">Your Username:</p>
                        <p id="settings-username" class="text-gray-700"></p>
                    </div>
                </div>

                <!-- NEW: Delete Account Section -->
                <div class="mt-8 pt-6 border-t border-red-200">
                    <h3 class="text-xl font-bold text-red-600">Delete Account</h3>
                    <p class="text-gray-600 mt-2">Permanently delete your account and all associated data. This action cannot be undone.</p>
                    <button id="delete-account-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700 transition duration-200">
                        Delete Your Account
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Bottom Navigation Bar (Mobile-only) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 flex justify-around items-center z-40">
        <a href="#" data-target="content-home" class="bottom-nav-link p-2 text-gray-600 active">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
        </a>
        <a href="#" data-target="content-discover" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 10V7m0 10l-6-3" /></svg>
        </a>
        <!-- This new link opens the post panel -->
        <a href="#" data-target="content-post" class="bottom-nav-link p-2 text-white bg-indigo-600 rounded-full shadow-lg">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        </a>
        <a href="#" data-target="content-messages" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        </a>
        <a href="#" id="bottom-nav-profile-link" data-target="content-profile" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </a>
        <!-- NEW: Settings link for mobile -->
        <a href="#" data-target="content-settings" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </a>
    </nav>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            deleteUser, // NEW: Import deleteUser
            reauthenticateWithPopup,
            reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            getDocs,
            collectionGroup,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot, 
            serverTimestamp, 
            runTransaction,
            where,
            increment,
            writeBatch,
            limit,
            updateDoc,
            startAfter,
            deleteDoc, // NEW: Import deleteDoc
            deleteField
        } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // --- 1. FIREBASE CONFIGURATION ---
        
        // Load config from global var or use your provided fallback
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // THIS IS YOUR CONFIG BLOCK:
                apiKey: "AIzaSyD-47gtfyUV75JPV03nqoMle4URzFK2B3E",
                authDomain: "nety-a602c.firebaseapp.com",
                projectId: "nety-a602c",
                storageBucket: "nety-a602c.firebasestorage.app",
                messagingSenderId: "874189944569",
                appId: "1:874189944569:web:d254db7f3841cf0ad2d428",
                measurementId: "G-6SE8GF9MD0"
              };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Safely initialize analytics (it can throw on unsupported environments)
        let analytics = null;
        try { analytics = getAnalytics(app); } catch (_) { analytics = null; }

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let currentUserProfile = null;
        let currentUserLikedPosts = new Set();
        
        let homeLastVisible = null;
        let discoverLastVisible = null;
        let profileLastVisible = null;
        let isLoadingHome = false;
        let isLoadingDiscover = false;
        let isLoadingProfile = false;
        
        let currentChatPartner = null;
        let unsubscribeConversation = null;

        let currentDiscoverFilter = 'new'; // NEW: Filter state
        let likeOpsInFlight = new Set(); // Prevent rapid like toggles per post

        // --- 3. DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const usernameModal = document.getElementById('username-modal');

        // Auth Forms
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const googleSigninBtn = document.getElementById('google-signin');
        const logoutButton = document.getElementById('logout-button');
        const authError = document.getElementById('auth-error');

        // Username Modal
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');
        const usernameError = document.getElementById('username-error');

        // Main App
        const postButton = document.getElementById('post-button');
        const postTextarea = document.getElementById('post-textarea');
        const postError = document.getElementById('post-error');
        const homeFeedContainer = document.getElementById('feed-container-home');
        const discoverFeedContainer = document.getElementById('feed-container-discover');
        
        // Post Panel (for mobile)
        const postPanel = document.getElementById('content-post');
        const postPanelTextarea = document.getElementById('post-panel-textarea');
        const postPanelButton = document.getElementById('post-panel-button');
        const postPanelError = document.getElementById('post-panel-error');
        const postPanelCancel = document.getElementById('post-cancel-button');
        const postPanelAvatar = document.getElementById('post-panel-user-avatar');

        // Load More Buttons
        const homeLoadMoreBtn = document.getElementById('home-load-more');
        const discoverLoadMoreBtn = document.getElementById('discover-load-more');
        const profileLoadMoreBtn = document.getElementById('profile-load-more');
        
        // DM Elements
        const dmContentPanel = document.getElementById('content-messages'); 
        const dmConversationList = document.getElementById('dm-conversation-list');
        const dmChatView = document.getElementById('dm-chat-container'); 
        const dmChatPlaceholder = document.getElementById('dm-placeholder-container'); 
        const dmChatHeader = document.getElementById('dm-chat-header');
        const dmForm = document.getElementById('dm-form');
        const dmInput = document.getElementById('dm-input');
        const dmFormButton = dmForm.querySelector('button[type="submit"]');
        const messageLog = document.getElementById('message-log');
        const dmBackButton = document.getElementById('dm-back-btn'); 

        // UI Elements
        const userAvatar = document.getElementById('user-avatar');
        const postUserAvatar = document.getElementById('post-user-avatar');
        const userDisplayname = document.getElementById('user-displayname');
        const userHandle = document.getElementById('user-handle');
        const sidebarProfileButton = document.getElementById('sidebar-profile-button');

        // Profile Page Elements
        const profilePage = document.getElementById('content-profile');
        const profileAvatar = document.getElementById('profile-page-avatar');
        const profileUsername = document.getElementById('profile-page-username');
        const profileHandle = document.getElementById('profile-page-handle');
        const profileFollowButton = document.getElementById('profile-follow-button');
        const profileFollowingCount = document.getElementById('profile-following-count');
        const profileFollowersCount = document.getElementById('profile-followers-count');
        const profileUid = document.getElementById('profile-page-uid');
        const profileFeedContainer = document.getElementById('profile-feed-container');

        // Settings Page Elements
        const settingsEmail = document.getElementById('settings-email');
        const settingsUsername = document.getElementById('settings-username');
        
        // NEW: Delete Account Elements
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteError = document.getElementById('delete-error');
        // Reauth elements
        const reauthSection = document.getElementById('reauth-section');
        const reauthHint = document.getElementById('reauth-hint');
        const reauthPasswordContainer = document.getElementById('reauth-password-container');
        const reauthPasswordInput = document.getElementById('reauth-password-input');
        const reauthPasswordBtn = document.getElementById('reauth-password-btn');
        const reauthGoogleBtn = document.getElementById('reauth-google-btn');
        const retryDeleteBtn = document.getElementById('retry-delete-btn');
        
        // NEW: Discover Filter Elements
        const discoverFilterSelect = document.getElementById('discover-filter-select');
        
        // --- 4. AUTH STATE CONTROLLER ---

        // Handle Canvas Auth Token
        async function attemptCanvasAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Canvas custom token sign-in failed:", error);
                }
            }
            // If no token or failed, onAuthStateChanged will proceed as normal
            // (either user is already logged in, or they see the auth UI)
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkUserProfile(user);
            } else {
                currentUser = null;
                currentUserProfile = null;
                showAuthUI();
            }
        });

        async function checkUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                currentUserProfile = docSnap.data();
                await initializeAppUI(user, currentUserProfile);
            } else {
                // First-time sign-in, need to create profile
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                usernameModal.classList.remove('hidden');
            }
        }

        function showAuthUI() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            deleteAccountModal.classList.add('hidden'); // NEW: Hide modal on logout
            
            // Clear pagination state
            homeLastVisible = null;
            discoverLastVisible = null;
            profileLastVisible = null;
            
            // Clear any active DM listeners
            if (unsubscribeConversation) unsubscribeConversation();
            currentChatPartner = null;
        }

        async function initializeAppUI(user, profile) {
            userDisplayname.textContent = profile.username;
            userHandle.textContent = `@${profile.username}`;
            const avatarUrl = user.photoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            userAvatar.src = avatarUrl;
            postUserAvatar.src = avatarUrl;
            postPanelAvatar.src = avatarUrl; 

            settingsEmail.textContent = user.email || 'Not provided';
            settingsUsername.textContent = `@${profile.username}`;
            
            await loadUserLikedPosts(user.uid);

            authContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            navigateTo("content-home"); // Start at home

            // Initial paginated load
            loadFollowingFeed(user.uid, false);
            loadDiscoverFeed(false);
        }

        // --- 5. AUTHENTICATION FUNCTIONS ---

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                signupForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Signup Error:", error);
                authError.textContent = error.message;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Login Error:", error);
                authError.textContent = error.message;
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                authError.textContent = '';
            } catch (error) {
                console.error("Google Signin Error:", error);
                authError.textContent = error.message;
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- 6. USERNAME CREATION ---

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim().toLowerCase();
            if (username.length < 3) {
                usernameError.textContent = 'Username must be at least 3 characters.';
                return;
            }
            if (!/^[a-z0-9_]+$/.test(username)) {
                usernameError.textContent = 'Username can only contain lowercase letters, numbers, and underscores.';
                return;
            }

            const user = auth.currentUser;
            const usernameRef = doc(db, 'usernames', username);
            const userRef = doc(db, 'users', user.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const usernameDoc = await transaction.get(usernameRef);
                    if (usernameDoc.exists()) {
                        throw new Error("This username is already taken.");
                    }
                    
                    transaction.set(usernameRef, { uid: user.uid });
                    
                    const newUserProfile = {
                        username: username,
                        email: user.email || '',
                        uid: user.uid,
                        createdAt: serverTimestamp(),
                        photoURL: user.photoURL || '',
                        followingCount: 0,
                        followersCount: 0
                    };
                    transaction.set(userRef, newUserProfile);
                    
                    currentUserProfile = newUserProfile;
                });

                usernameError.textContent = '';
                await initializeAppUI(user, currentUserProfile);

            } catch (error) {
                console.error("Username Save Error:", error);
                usernameError.textContent = error.message;
            }
        });

        // --- 7. POSTING (FIRESTORE) ---

        // Generic function to create a post
        async function createPost(text, onStart, onSuccess, onError) {
            onStart(); // Disable button, clear errors
            const postText = text.trim(); 

            if (postText.length > 1000) {
                onError('Post is too long (max 1000 chars).');
                return;
            }
            if (!postText) {
                onError('Post cannot be empty.');
                return;
            }
            
            if (currentUser && currentUserProfile) {
                try {
                    const newPostData = {
                        text: postText,
                        userId: currentUser.uid,
                        username: currentUserProfile.username,
                        userPhotoURL: currentUser.photoURL || '',
                        createdAt: serverTimestamp(),
                        likeCount: 0,
                        commentCount: 0,
                        popularityScore: 0 // NEW: Initialize popularity score
                    };
                    
                    const docRef = await addDoc(collection(db, "posts"), newPostData);
                    
                    // Optimistic UI update: Add post to top of home feed
                    const postElement = createPostElement(docRef.id, {
                        ...newPostData,
                        createdAt: { toDate: () => new Date() } // Mock server timestamp
                    });
                    homeFeedContainer.prepend(postElement);
                    
                    onSuccess(); // Clear textarea, etc.

                } catch (error) {
                    console.error("Post Error:", error);
                    onError(`Error creating post: ${error.message}`);
                }
            }
        }

        // Desktop post button
        postButton.addEventListener('click', () => {
            createPost(
                postTextarea.value,
                () => { // onStart
                    postButton.disabled = true;
                    postError.textContent = '';
                },
                () => { // onSuccess
                    postTextarea.value = '';
                    postError.textContent = '';
                    postButton.disabled = false;
                },
                (err) => { // onError
                    postError.textContent = err;
                    postButton.disabled = false;
                }
            );
        });

        // Mobile post panel button
        postPanelButton.addEventListener('click', () => {
            createPost(
                postPanelTextarea.value,
                () => { // onStart
                    postPanelButton.disabled = true;
                    postPanelError.textContent = '';
                },
                () => { // onSuccess
                    postPanelTextarea.value = '';
                    postPanelError.textContent = '';
                    postPanelButton.disabled = false;
                    navigateTo('content-home'); // Go to home feed after posting
                },
                (err) => { // onError
                    postPanelError.textContent = err;
                    postPanelButton.disabled = false;
                }
            );
        });
        
        // Mobile post panel cancel button
        postPanelCancel.addEventListener('click', () => {
            postPanelTextarea.value = '';
            postPanelError.textContent = '';
            navigateTo('content-home'); // Go back home
        });


        // --- 8. LOADING FEEDS & POSTS (PAGINATION) ---

        const POST_PAGE_SIZE = 10;

        /**
         * Generic Feed Loader for Pagination
         * @param {string} feedType - 'home', 'discover', or 'profile'
         * @param {Query} baseQuery - The Firestore query to execute
         * @param {QueryConstraint} sortConstraint - The orderBy constraint
         * @param {boolean} isLoadMore - Whether this is an initial load or "load more"
         */
        async function loadFeed(feedType, baseQuery, sortConstraint, isLoadMore) {
            let container, loadMoreBtn, lastVisible, isLoading;

            if (feedType === 'home') {
                container = homeFeedContainer;
                loadMoreBtn = homeLoadMoreBtn;
                lastVisible = homeLastVisible;
                isLoading = isLoadingHome;
            } else if (feedType === 'discover') {
                container = discoverFeedContainer;
                loadMoreBtn = discoverLoadMoreBtn;
                lastVisible = discoverLastVisible;
                isLoading = isLoadingDiscover;
            } else { // profile
                container = profileFeedContainer;
                loadMoreBtn = profileLoadMoreBtn;
                lastVisible = profileLastVisible;
                isLoading = isLoadingProfile;
            }

            if (isLoading) return;
            
            if (feedType === 'home') isLoadingHome = true;
            else if (feedType === 'discover') isLoadingDiscover = true;
            else isLoadingProfile = true;

            if (!isLoadMore) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">Loading feed...</p>';
                lastVisible = null;
            }

            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';

            try {
                // MODIFIED: Use the passed-in sortConstraint
                let queryConstraints = [sortConstraint, limit(POST_PAGE_SIZE)];
                if (isLoadMore && lastVisible) {
                    queryConstraints.push(startAfter(lastVisible));
                }
                
                const finalQuery = query(baseQuery, ...queryConstraints);
                const snapshot = await getDocs(finalQuery);

                if (!isLoadMore) {
                    container.innerHTML = ''; // Clear "Loading..."
                }

                if (snapshot.empty) {
                    if (!isLoadMore) {
                        if (feedType === 'home') {
                             container.innerHTML = '<p class="text-gray-500 text-center p-4">Follow users to see their posts here. Check out the Discover tab!</p>';
                        } else {
                            container.innerHTML = '<p class="text-gray-500 text-center p-4">No posts found.</p>';
                        }
                    }
                    loadMoreBtn.textContent = 'No more posts';
                    loadMoreBtn.classList.add('hidden');
                } else {
                    snapshot.forEach(doc => {
                        const postElement = createPostElement(doc.id, doc.data());
                        container.appendChild(postElement);
                    });

                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                    
                    if (snapshot.docs.length < POST_PAGE_SIZE) {
                        loadMoreBtn.textContent = 'No more posts';
                        loadMoreBtn.classList.add('hidden');
                    } else {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Load More';
                        loadMoreBtn.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error(`Error loading ${feedType} feed:`, error);
                container.innerHTML = `<p class="text-red-500 text-center">Error loading feed. ${error.message}</p>`;
            }
            
            if (feedType === 'home') {
                homeLastVisible = lastVisible;
                isLoadingHome = false;
            } else if (feedType === 'discover') {
                discoverLastVisible = lastVisible;
                isLoadingDiscover = false;
            } else {
                profileLastVisible = lastVisible;
                isLoadingProfile = false;
            }
        }
        
        async function loadFollowingFeed(userId, isLoadMore = false) {
            if (!isLoadMore) {
                homeLastVisible = null;
            }
            
            // Get list of users we follow
            const followingCol = collection(db, "users", userId, "following");
            const followingSnapshot = await getDocs(followingCol);
            
            const followedUserIds = [userId]; // Always include self
            followingSnapshot.forEach(doc => {
                followedUserIds.push(doc.id);
            });

            // If we can use a single 'in' (<=10 IDs), use normal paginated feed
            if (followedUserIds.length <= 10) {
                const baseQuery = query(
                    collection(db, "posts"), 
                    where("userId", "in", followedUserIds)
                );
                await loadFeed('home', baseQuery, orderBy("createdAt", "desc"), isLoadMore);
                return;
            }

            // Otherwise: multi-query first page merge, disable Load More
            if (isLoadMore) {
                // No reliable cross-chunk pagination; hide load more
                homeLoadMoreBtn.classList.add('hidden');
                return;
            }

            isLoadingHome = true;
            homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Loading feed...</p>';
            homeLoadMoreBtn.classList.add('hidden');

            // Chunk into groups of 10 and fetch top N from each
            const chunks = [];
            for (let i = 0; i < followedUserIds.length; i += 10) {
                chunks.push(followedUserIds.slice(i, i + 10));
            }

            try {
                const resultsPerChunk = await Promise.all(chunks.map(async (ids) => {
                    const q = query(
                        collection(db, "posts"),
                        where("userId", "in", ids),
                        orderBy("createdAt", "desc"),
                        limit(POST_PAGE_SIZE)
                    );
                    const snap = await getDocs(q);
                    return snap.docs;
                }));

                const allDocs = Array.from(new Map(
                    resultsPerChunk
                        .flat()
                        .map(d => [d.id, d])
                ).values());

                allDocs.sort((a, b) => {
                    const ad = a.data().createdAt?.toDate ? a.data().createdAt.toDate().getTime() : 0;
                    const bd = b.data().createdAt?.toDate ? b.data().createdAt.toDate().getTime() : 0;
                    return bd - ad;
                });

                const firstPage = allDocs.slice(0, POST_PAGE_SIZE);
                homeFeedContainer.innerHTML = '';
                if (firstPage.length === 0) {
                    homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No posts found.</p>';
                } else {
                    firstPage.forEach(d => {
                        homeFeedContainer.appendChild(createPostElement(d.id, d.data()));
                    });
                }

                // Inform user about pagination limitation
                const note = document.createElement('p');
                note.className = 'text-xs text-gray-500 text-center mt-2';
                note.textContent = 'Showing recent posts from followed users. For more, use Discover.';
                homeFeedContainer.appendChild(note);

            } catch (error) {
                console.error('Error loading home feed (chunked):', error);
                homeFeedContainer.innerHTML = `<p class="text-red-500 text-center">Error loading feed. ${error.message}</p>`;
            }

            isLoadingHome = false;
        }

        // MODIFIED: To use filter state
        function loadDiscoverFeed(isLoadMore = false) {
            if (!isLoadMore) {
                discoverLastVisible = null;
            }
            
            let sortConstraint;
            switch (currentDiscoverFilter) {
                case 'popular':
                    sortConstraint = orderBy("popularityScore", "desc");
                    break;
                case 'likes':
                    sortConstraint = orderBy("likeCount", "desc");
                    break;
                case 'comments':
                    sortConstraint = orderBy("commentCount", "desc");
                    break;
                case 'new':
                default:
                    sortConstraint = orderBy("createdAt", "desc");
                    break;
            }

            const baseQuery = query(collection(db, "posts"));
            loadFeed('discover', baseQuery, sortConstraint, isLoadMore);
        }

        function loadProfileFeed(userId, isLoadMore = false) {
            if (!isLoadMore) {
                profileLastVisible = null;
            }
            const baseQuery = query(
                collection(db, "posts"), 
                where("userId", "==", userId)
            );
            // MODIFIED: Pass sort constraint
            loadFeed('profile', baseQuery, orderBy("createdAt", "desc"), isLoadMore);
        }
        
        function createPostElement(postId, post) {
            const article = document.createElement('article');
            article.className = 'bg-white p-4 rounded-lg shadow-sm animate-fade-in';
            article.dataset.postId = postId;
            article.dataset.userId = post.userId;

            const date = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleString() : 'Just now';
            const avatarUrl = post.userPhotoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${post.username.charAt(0).toUpperCase()}`;

            const header = document.createElement('div');
            header.className = 'flex items-center space-x-3';
            
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarUrl;
            avatarImg.alt = `${post.username}'s avatar`;
            avatarImg.className = 'w-10 h-10 rounded-full cursor-pointer';
            avatarImg.onclick = () => showProfile(post.userId);

            const meta = document.createElement('div');
            const nameP = document.createElement('p');
            nameP.className = 'font-semibold text-gray-800 cursor-pointer hover:underline';
            nameP.textContent = post.username || 'Unknown';
            nameP.onclick = () => showProfile(post.userId);

            const infoP = document.createElement('p');
            infoP.className = 'text-sm text-gray-500';
            infoP.textContent = `@${post.username || 'unknown'}  ${date}`;

            meta.appendChild(nameP);
            meta.appendChild(infoP);
            header.appendChild(avatarImg);
            header.appendChild(meta);

            const paragraph = document.createElement('p');
            paragraph.className = 'mt-4 text-gray-700 text-lg whitespace-pre-wrap';
            // XSS PREVENTION: Using .textContent ensures the post text
            // is rendered as plain text, not as HTML.
            paragraph.textContent = post.text || '';

            const footer = document.createElement('div');
            footer.className = 'flex justify-around items-center mt-4 pt-3 border-t';

            // Like Button
            const likeBtn = document.createElement('button');
            likeBtn.type = 'button';
            const isLiked = currentUserLikedPosts.has(postId);
            likeBtn.className = `flex items-center space-x-2 text-gray-500 hover:text-red-500 group ${isLiked ? 'liked-button' : ''}`;
            likeBtn.setAttribute('aria-label', 'Like post');
            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>`;
            
            const likeCount = document.createElement('span');
            likeCount.className = 'text-sm like-count';
            likeCount.textContent = post.likeCount || 0;
            likeBtn.appendChild(likeCount);
            
            likeBtn.addEventListener('click', () => {
                const currentlyLiked = currentUserLikedPosts.has(postId);
                toggleLike(postId, currentlyLiked);
            });

            // Comment Button
            const commentBtn = document.createElement('button');
            commentBtn.type = 'button';
            commentBtn.className = 'flex items-center space-x-2 text-gray-500 hover:text-indigo-500 group';
            commentBtn.setAttribute('aria-label', 'Comment on post');
            commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`;
            
            const commentCount = document.createElement('span');
            commentCount.className = 'text-sm comment-count';
            commentCount.textContent = post.commentCount || 0;
            commentBtn.appendChild(commentCount);
            
            commentBtn.addEventListener('click', () => toggleCommentSection(postId));

            footer.appendChild(likeBtn);
            footer.appendChild(commentBtn);

            // Comment Section (initially hidden)
            const commentSection = document.createElement('div');
            commentSection.id = `comments-section-${postId}`;
            commentSection.className = 'hidden mt-4 pt-4 border-t';

            const commentList = document.createElement('div');
            commentList.id = `comments-list-${postId}`;
            commentList.className = 'space-y-3 mb-4 max-h-60 overflow-y-auto';
            
            const commentForm = document.createElement('form');
            commentForm.id = `comment-form-${postId}`;
            commentForm.className = 'flex items-start space-x-3';
            
            const commentAvatar = document.createElement('img');
            commentAvatar.src = userAvatar.src;
            commentAvatar.className = 'w-9 h-9 rounded-full';
            
            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.placeholder = 'Write a comment...';
            commentInput.className = 'flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400';
            commentInput.name = 'commentText';

            const commentSubmitBtn = document.createElement('button');
            commentSubmitBtn.type = 'submit';
            commentSubmitBtn.className = 'bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200';
            commentSubmitBtn.textContent = 'Reply';

            commentForm.appendChild(commentAvatar);
            commentForm.appendChild(commentInput);
            commentForm.appendChild(commentSubmitBtn);

            commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, postId));

            commentSection.appendChild(commentList);
            commentSection.appendChild(commentForm);

            article.appendChild(header);
            article.appendChild(paragraph);
            article.appendChild(footer);
            article.appendChild(commentSection);

            return article;
        }


        // --- 9. LIKE & COMMENT FUNCTIONS ---

        async function loadUserLikedPosts(userId) {
            currentUserLikedPosts.clear();
            const q = query(collection(db, "users", userId, "likedPosts"));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => {
                currentUserLikedPosts.add(doc.id);
            });
        }

        async function toggleLike(postId, isLiked) {
            if (!currentUser) return;
            if (likeOpsInFlight.has(postId)) return; // prevent rapid double-toggles
            likeOpsInFlight.add(postId);
            
            // --- Optimistic UI Update ---
            updateLikeUI(postId, !isLiked);
            if (isLiked) {
                currentUserLikedPosts.delete(postId);
            } else {
                currentUserLikedPosts.add(postId);
            }
            // --- End Optimistic Update ---

            const postRef = doc(db, "posts", postId);
            const userLikeRef = doc(db, "users", currentUser.uid, "likedPosts", postId);
            const postLikeRef = doc(db, "posts", postId, "likes", currentUser.uid);

            const batch = writeBatch(db);
            
            // NEW: Update popularityScore along with likeCount
            if (isLiked) {
                // User is un-liking
                batch.delete(userLikeRef);
                batch.delete(postLikeRef);
                batch.update(postRef, { 
                    likeCount: increment(-1),
                    popularityScore: increment(-1) // -1 for like
                });
            } else {
                // User is liking
                batch.set(userLikeRef, { likedAt: serverTimestamp() });
                batch.set(postLikeRef, { 
                    userId: currentUser.uid, 
                    username: currentUserProfile.username, 
                    likedAt: serverTimestamp() 
                });
                batch.update(postRef, { 
                    likeCount: increment(1),
                    popularityScore: increment(1) // +1 for like
                });
            }

            try {
                await batch.commit();
                // UI is already updated
            } catch (error) {
                console.error("Error toggling like:", error);
                // Rollback optimistic update on error
                updateLikeUI(postId, isLiked); // Revert to original state
                if (isLiked) {
                    currentUserLikedPosts.add(postId);
                } else {
                    currentUserLikedPosts.delete(postId);
                }
            } finally { likeOpsInFlight.delete(postId); }
        }
        
        function updateLikeUI(postId, isLiked) {
            // Find all instances of this post (e.g., in home and discover)
            const postElements = document.querySelectorAll(`article[data-post-id="${postId}"]`);
            postElements.forEach(postElement => {
                const likeBtn = postElement.querySelector('button[aria-label="Like post"]');
                const likeCountEl = postElement.querySelector('.like-count');
                if (!likeBtn || !likeCountEl) return;
                
                const currentCount = parseInt(likeCountEl.textContent);

                if (isLiked) {
                    likeBtn.classList.add('liked-button');
                    likeCountEl.textContent = currentCount + 1;
                } else {
                    likeBtn.classList.remove('liked-button');
                    likeCountEl.textContent = currentCount - 1;
                }
            });
        }
        
        async function toggleCommentSection(postId) {
            const commentSection = document.getElementById(`comments-section-${postId}`);
            if (commentSection) {
                const isHidden = commentSection.classList.toggle('hidden');
                if (!isHidden) {
                    // Load comments only when opened
                    await loadCommentsOnce(postId);
                    commentSection.querySelector('input[name="commentText"]').focus();
                }
            }
        }
        
        async function loadCommentsOnce(postId) {
            const listElement = document.getElementById(`comments-list-${postId}`);
            if (!listElement || listElement.dataset.loaded === 'true') {
                return; // Already loaded
            }

            listElement.innerHTML = '<p class="text-gray-500 text-sm">Loading comments...</p>';
            listElement.dataset.loaded = 'true'; // Mark as loading/loaded

            const q = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"), limit(50));
            const snapshot = await getDocs(q);

            listElement.innerHTML = '';
            if (snapshot.empty) {
                listElement.innerHTML = '<p class="text-gray-500 text-sm text-center">No comments yet.</p>';
            } else {
                snapshot.forEach(doc => {
                    listElement.appendChild(createCommentElement(doc.data()));
                });
            }
        }
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3';
            
            const avatarUrl = comment.userPhotoURL || `https://placehold.co/36x36/E0E7FF/4F46E5?text=${comment.username.charAt(0).toUpperCase()}`;
            const avatar = document.createElement('img');
            avatar.src = avatarUrl;
            avatar.className = 'w-9 h-9 rounded-full cursor-pointer';
            avatar.onclick = () => showProfile(comment.userId);
            
            const content = document.createElement('div');
            content.className = 'flex-1 bg-slate-100 rounded-lg p-3';
            
            const name = document.createElement('p');
            name.className = 'text-sm font-semibold text-gray-800 cursor-pointer hover:underline';
            name.textContent = comment.username;
            name.onclick = () => showProfile(comment.userId);

            const text = document.createElement('p');
            text.className = 'text-sm text-gray-700';
            // XSS PREVENTION: Using .textContent to render comment
            text.textContent = comment.text;
            
            content.appendChild(name);
            content.appendChild(text);
            div.appendChild(avatar);
            div.appendChild(content);
            return div;
        }
        
        async function handleCommentSubmit(e, postId) {
            e.preventDefault();
            if (!currentUser) return;
            
            const form = e.target;
            const input = form.commentText;
            const text = input.value.trim();
            
            if (!text) return;
            
            form.querySelector('button[type="submit"]').disabled = true;

            const newComment = {
                text: text, // Stored raw, rendered with .textContent
                userId: currentUser.uid,
                username: currentUserProfile.username,
                userPhotoURL: currentUser.photoURL || '',
                createdAt: serverTimestamp()
            };

            const postRef = doc(db, "posts", postId);
            const newCommentRef = doc(collection(db, "posts", postId, "comments"));
            const batch = writeBatch(db);

            try {
                batch.set(newCommentRef, newComment);
                // NEW: Update commentCount AND popularityScore
                batch.update(postRef, { 
                    commentCount: increment(1),
                    popularityScore: increment(3) // +3 for comment
                });
                await batch.commit();

                // Optimistic UI update
                const listElement = document.getElementById(`comments-list-${postId}`);
                if (listElement.dataset.loaded === 'true') {
                    const noComments = listElement.querySelector('p.text-center');
                    if (noComments) noComments.remove();
                    
                    listElement.appendChild(createCommentElement({
                        ...newComment,
                        createdAt: { toDate: () => new Date() }
                    }));
                    listElement.scrollTop = listElement.scrollHeight;
                }
                
                // Optimistic count update (for all post instances)
                const postElements = document.querySelectorAll(`article[data-post-id="${postId}"]`);
                postElements.forEach(postElement => {
                    const countEl = postElement.querySelector('.comment-count');
                    if(countEl) {
                        countEl.textContent = parseInt(countEl.textContent) + 1;
                    }
                });
                
                input.value = '';
                
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Error adding comment. Please try again.");
            }
            form.querySelector('button[type="submit"]').disabled = false;
        }

        // --- 10. PROFILE & FOLLOWING FUNCTIONS ---

        async function showProfile(userId) {
            // Reset pagination for profile feed
            profileLastVisible = null; 
            isLoadingProfile = false;
            
            navigateTo("content-profile");
            
            const currentFollowButton = document.getElementById('profile-follow-button');
            profileUsername.textContent = 'Loading...';
            profileHandle.textContent = '...';
            profileFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Loading posts...</p>';
            currentFollowButton.classList.add('hidden');

            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                profileUsername.textContent = 'User not found';
                profileHandle.textContent = '';
                profileFeedContainer.innerHTML = '';
                return;
            }

            const profile = userSnap.data();
            
            profileUsername.textContent = profile.username;
            profileHandle.textContent = `@${profile.username}`;
            profileUid.textContent = profile.uid;
            profileAvatar.src = profile.photoURL || `https://placehold.co/80x80/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            profileFollowingCount.textContent = profile.followingCount || 0;
            profileFollowersCount.textContent = profile.followersCount || 0;

            // Follow Button Logic
            if (userId === currentUser.uid) {
                currentFollowButton.classList.add('hidden');
            } else {
                currentFollowButton.classList.remove('hidden');
                const followRef = doc(db, "users", currentUser.uid, "following", userId);
                const followSnap = await getDoc(followRef);
                
                if (followSnap.exists()) {
                    currentFollowButton.textContent = 'Unfollow';
                    currentFollowButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.add('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'true';
                } else {
                    currentFollowButton.textContent = 'Follow';
                    currentFollowButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'false';
                }
                
                // Re-clone and re-attach listener to avoid stale closures
                const newFollowBtn = currentFollowButton.cloneNode(true);
                currentFollowButton.parentNode.replaceChild(newFollowBtn, currentFollowButton);
                
                newFollowBtn.addEventListener('click', () => {
                    const isFollowing = newFollowBtn.dataset.following === 'true';
                    if (isFollowing) {
                        unfollowUser(userId, profile.username, newFollowBtn); 
                    } else {
                        followUser(userId, profile.username, newFollowBtn);
                    }
                });
            }
            
            // Initial paginated load for profile
            loadProfileFeed(userId, false);
        }

        async function followUser(targetUserId, targetUsername, button) {
            button.disabled = true;
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.set(followingRef, {
                username: targetUsername,
                followedAt: serverTimestamp()
            });
            batch.set(followerRef, {
                username: currentUserProfile.username,
                followedAt: serverTimestamp()
            });
            
            batch.update(currentUserRef, { followingCount: increment(1) });
            batch.update(targetUserRef, { followersCount: increment(1) });
            
            try {
                await batch.commit();
                // Optimistic UI update
                button.textContent = 'Unfollow';
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'true';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) + 1;
                // Reload home feed on next visit
                homeLastVisible = null; 
            } catch (error) {
                console.error("Error following user:", error);
            }
            button.disabled = false;
        }
        
        async function unfollowUser(targetUserId, targetUsername, button) {
            button.disabled = true;
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.delete(followingRef);
            batch.delete(followerRef);
            batch.update(currentUserRef, { followingCount: increment(-1) });
            batch.update(targetUserRef, { followersCount: increment(-1) });

            try {
                await batch.commit();
                // Optimistic UI update
                button.textContent = 'Follow';
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'false';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) - 1;
                // Reload home feed on next visit
                homeLastVisible = null;
            } catch (error) {
                console.error("Error unfollowing user:", error);
            }
            button.disabled = false;
        }

        // --- 11. DIRECT MESSAGES ---
        
        dmBackButton.addEventListener('click', () => {
            dmContentPanel.classList.remove('mobile-chat-view');
            dmContentPanel.classList.add('mobile-chat-list');
            resetChatView();
        });

        function resetChatView() {
            dmChatView.classList.add('hidden');
            dmChatPlaceholder.classList.remove('hidden'); // This is the desktop placeholder
            dmChatHeader.textContent = 'Select a conversation';
            dmInput.disabled = true;
            dmFormButton.disabled = true;
            dmInput.placeholder = 'Select a conversation to message...';
            messageLog.innerHTML = '';
            currentChatPartner = null;
            if (unsubscribeConversation) unsubscribeConversation();
            unsubscribeConversation = null;
        }

        async function loadConversationList() {
            if (!currentUser) return;

            dmConversationList.innerHTML = '<p class="p-4 text-gray-500">Loading conversations...</p>';

            try {
                const convosQ = query(
                    collection(db, "conversations"),
                    where("members", "array-contains", currentUser.uid),
                    orderBy("lastMessageAt", "desc"),
                    limit(50)
                );
                const convSnap = await getDocs(convosQ);

                if (convSnap.empty) {
                    dmConversationList.innerHTML = '<p class="p-4 text-gray-500">No conversations yet. Start one from a user profile.</p>';
                    return;
                }

                dmConversationList.innerHTML = '';
                convSnap.forEach(c => {
                    const data = c.data();
                    const otherId = data.members.find(m => m !== currentUser.uid) || '';
                    const otherUsername = (data.memberInfo && data.memberInfo[otherId]?.username) || 'Unknown';
                    const el = document.createElement('div');
                    el.className = "p-4 border-b border-gray-200 cursor-pointer hover:bg-slate-100";
                    el.textContent = otherUsername;
                    el.dataset.userId = otherId;
                    el.dataset.username = otherUsername;
                    el.onclick = () => {
                        Array.from(dmConversationList.children).forEach(child => child.classList.remove('bg-indigo-100', 'font-semibold'));
                        el.classList.add('bg-indigo-100', 'font-semibold');
                        openConversation(otherId, otherUsername);
                    };
                    dmConversationList.appendChild(el);
                });
            } catch (e) {
                console.error('Error loading conversations list', e);
                dmConversationList.innerHTML = '<p class="p-4 text-red-500">Error loading conversations.</p>';
            }
        }

        async function openConversation(partnerId, partnerUsername) {
            currentChatPartner = { uid: partnerId, username: partnerUsername };
            
            // Show chat view on mobile
            dmContentPanel.classList.remove('mobile-chat-list');
            dmContentPanel.classList.add('mobile-chat-view');

            dmChatView.classList.remove('hidden');
            dmChatPlaceholder.classList.add('hidden');
            dmChatHeader.textContent = `Chat with ${partnerUsername}`;
            dmInput.disabled = false;
            dmFormButton.disabled = false;
            dmInput.placeholder = `Message ${partnerUsername}...`;
            
            const convoId = [currentUser.uid, partnerId].sort().join('_');
            const convoDocRef = doc(db, "conversations", convoId);
            
            try {
                // Ensure conversation doc exists for security rules
                await setDoc(convoDocRef, {
                    members: [currentUser.uid, partnerId],
                    memberInfo: {
                        [currentUser.uid]: { username: currentUserProfile.username },
                        [partnerId]: { username: partnerUsername }
                    }
                }, { merge: true });
                
                loadConversationMessages(convoId);
            } catch (error) {
                console.error("Error ensuring conversation exists:", error);
                messageLog.innerHTML = '<p class="text-red-500 text-center">Could not open conversation.</p>';
            }
        }

        function loadConversationMessages(convoId) {
            if (unsubscribeConversation) unsubscribeConversation();

            const q = query(collection(db, "conversations", convoId, "messages"), orderBy("createdAt", "asc"), limit(100));
            
            unsubscribeConversation = onSnapshot(q, (snapshot) => {
                messageLog.innerHTML = '';
                if (snapshot.empty) {
                    messageLog.innerHTML = '<p class="text-gray-500 text-center p-4">No messages yet. Say hi!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const msgElement = document.createElement('div');
                    
                    const text = document.createElement('p');
                    // XSS PREVENTION: Using .textContent
                    text.textContent = msg.text;
                    msgElement.appendChild(text);

                    if (msg.senderId === currentUser.uid) {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-indigo-600 text-white ml-auto";
                    } else {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-slate-200 text-gray-800 mr-auto";
                    }
                    
                    messageLog.appendChild(msgElement);
                });
                messageLog.scrollTop = messageLog.scrollHeight;
            }, (error) => {
                console.error("Error loading messages:", error);
                messageLog.innerHTML = '<p class="text-red-500 text-center">Error loading messages.</p>';
            });
        }

        dmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = dmInput.value.trim();
            
            if (!text || !currentUser || !currentChatPartner) return;
            
            const tempMessage = dmInput.value;
            dmInput.value = '';
            dmFormButton.disabled = true;
            
            const convoId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const convoDocRef = doc(db, "conversations", convoId);
            const messagesColRef = collection(convoDocRef, "messages");

            try {
                // Update parent doc first
                await setDoc(convoDocRef, {
                    lastMessage: text,
                    lastMessageAt: serverTimestamp(),
                    lastMessageSenderId: currentUser.uid
                }, { merge: true });

                // Then add message to subcollection
                await addDoc(messagesColRef, {
                    text: text, // Stored raw
                    senderId: currentUser.uid,
                    senderUsername: currentUserProfile.username,
                    createdAt: serverTimestamp()
                });

                dmFormButton.disabled = false;
                dmInput.focus();
                
            } catch (error) {
                console.error("DM Send Error:", error);
                alert(`Error sending message: ${error.message}`);
                dmInput.value = tempMessage;
                dmFormButton.disabled = false;
            }
        });

        // --- 12. APP NAVIGATION (TABS) ---
        
        const navLinks = document.querySelectorAll('.nav-link');
        const bottomNavLinks = document.querySelectorAll('.bottom-nav-link'); 
        const contentPanels = document.querySelectorAll('.content-panel');
        const sidebarPostButton = document.getElementById('sidebar-post-button');

        function navigateTo(targetId) {
             // Update Sidebar Nav Link styles
            navLinks.forEach(nav => {
                if (nav.dataset.target === targetId) {
                    nav.classList.add('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.remove('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                } else {
                    nav.classList.remove('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.add('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                }
            });

            // Update Bottom Nav Link styles
            bottomNavLinks.forEach(nav => {
                if (nav.dataset.target === targetId) {
                    nav.classList.add('active');
                } else {
                    nav.classList.remove('active');
                }
            });

            // Show/Hide Content Panels
            contentPanels.forEach(panel => {
                if (panel.id === targetId) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            // Handle DM listeners
            if (targetId === 'content-messages') {
                loadConversationList();
                resetChatView();
                // Set mobile view to list
                dmContentPanel.classList.remove('mobile-chat-view');
                dmContentPanel.classList.add('mobile-chat-list');
            } else if (unsubscribeConversation) {
                // If we navigate *away* from messages, kill the listener
                unsubscribeConversation();
                unsubscribeConversation = null;
                currentChatPartner = null;
            }

            // Scroll to top on navigation
            window.scrollTo(0, 0);
        }
        
        // --- 13. ACCOUNT DELETION ---

        // Helper: delete a query's results in batches (with optional per-doc callback)
        async function deleteByQuery(q, { batchSize = 200, perDoc } = {}) {
            const snapshot = await getDocs(q);
            if (snapshot.empty) return 0;
            let deleted = 0;
            let batch = writeBatch(db);
            let ops = 0;
            for (const d of snapshot.docs) {
                if (perDoc) await perDoc(d, batch);
                else batch.delete(d.ref);
                ops += 1;
                deleted += 1;
                if (ops >= batchSize) {
                    await batch.commit();
                    batch = writeBatch(db);
                    ops = 0;
                }
            }
            if (ops > 0) await batch.commit();
            return deleted;
        }

        async function deleteCollection(path, { batchSize = 200 } = {}) {
            let total = 0;
            while (true) {
                const q = query(collection(db, path), limit(batchSize));
                const snapshot = await getDocs(q);
                if (snapshot.empty) break;
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
                total += snapshot.size;
                if (snapshot.size < batchSize) break;
            }
            return total;
        }

        async function deleteSubcollection(parentPath, subcollectionName) {
            return await deleteCollection(`${parentPath}/${subcollectionName}`);
        }

        async function deleteUserPostsAndSubcollections(userId) {
            const postsQ = query(collection(db, "posts"), where("userId", "==", userId), limit(100));
            const postsSnap = await getDocs(postsQ);
            if (postsSnap.empty) return;
            for (const postDoc of postsSnap.docs) {
                const postId = postDoc.id;
                const postPath = `posts/${postId}`;
                // Delete comments
                await deleteSubcollection(postPath, "comments");
                // Delete likes
                await deleteSubcollection(postPath, "likes");
                // Finally delete post
                await deleteDoc(postDoc.ref);
            }
            // If more than 100 posts, recurse until none left
            if (postsSnap.size === 100) await deleteUserPostsAndSubcollections(userId);
        }

        async function removeUserLikedPostsAndAdjustCounters(userId) {
            const likedQ = query(collection(db, "users", userId, "likedPosts"), limit(200));
            const likedSnap = await getDocs(likedQ);
            if (likedSnap.empty) return;
            for (const liked of likedSnap.docs) {
                const postId = liked.id;
                const postRef = doc(db, "posts", postId);
                const postLikeRef = doc(db, "posts", postId, "likes", userId);
                const userLikeRef = doc(db, "users", userId, "likedPosts", postId);
                const batch = writeBatch(db);
                batch.delete(userLikeRef);
                batch.delete(postLikeRef);
                batch.update(postRef, { likeCount: increment(-1), popularityScore: increment(-1) });
                try { await batch.commit(); } catch (_) { /* ignore */ }
            }
            if (likedSnap.size === 200) await removeUserLikedPostsAndAdjustCounters(userId);
        }

        async function removeUserCommentsAndAdjustCounters(userId) {
            const commentsQ = query(collectionGroup(db, "comments"), where("userId", "==", userId), limit(200));
            const snap = await getDocs(commentsQ);
            if (snap.empty) return;
            for (const c of snap.docs) {
                const parentPostRef = c.ref.parent.parent; // posts/{postId}
                if (parentPostRef) {
                    const batch = writeBatch(db);
                    batch.delete(c.ref);
                    batch.update(parentPostRef, { commentCount: increment(-1), popularityScore: increment(-3) });
                    try { await batch.commit(); } catch (_) { /* ignore */ }
                } else {
                    try { await deleteDoc(c.ref); } catch (_) { /* ignore */ }
                }
            }
            if (snap.size === 200) await removeUserCommentsAndAdjustCounters(userId);
        }

        async function removeFollowGraphs(userId) {
            // Decrement counters on counterparts as best-effort
            const followingQ = query(collection(db, "users", userId, "following"), limit(200));
            const followingSnap = await getDocs(followingQ);
            for (const f of followingSnap.docs) {
                const targetRef = doc(db, "users", f.id);
                try { await updateDoc(targetRef, { followersCount: increment(-1) }); } catch (_) {}
            }
            await deleteCollection(`users/${userId}/following`);

            const followersQ = query(collection(db, "users", userId, "followers"), limit(200));
            const followersSnap = await getDocs(followersQ);
            for (const f of followersSnap.docs) {
                const followerRef = doc(db, "users", f.id);
                try { await updateDoc(followerRef, { followingCount: increment(-1) }); } catch (_) {}
            }
            await deleteCollection(`users/${userId}/followers`);
        }

        async function scrubDirectMessagesForUser(userId) {
            const convosQ = query(collection(db, "conversations"), where("members", "array-contains", userId), limit(50));
            const convosSnap = await getDocs(convosQ);
            for (const convo of convosSnap.docs) {
                const convoId = convo.id;
                // Delete user's messages in this conversation
                const msgsQ = query(collection(db, "conversations", convoId, "messages"), where("senderId", "==", userId), limit(200));
                await deleteByQuery(msgsQ);
                // Remove memberInfo entry and clear lastMessage if it was theirs
                const data = convo.data();
                const updates = { [`memberInfo.${userId}`]: deleteField() };
                if (data.lastMessageSenderId === userId) {
                    updates.lastMessage = "";
                    updates.lastMessageSenderId = "";
                    updates.lastMessageAt = serverTimestamp();
                }
                try { await updateDoc(convo.ref, updates); } catch (_) {}
            }
            // Note: We intentionally keep conversations for the other participant.
        }
        
        deleteAccountBtn.addEventListener('click', () => {
            deleteError.textContent = '';
            confirmDeleteBtn.disabled = false;
            // Hide reauth UI by default
            reauthSection.classList.add('hidden');
            reauthPasswordContainer.classList.add('hidden');
            reauthGoogleBtn.classList.add('hidden');
            if (reauthPasswordInput) reauthPasswordInput.value = '';
            deleteAccountModal.classList.remove('hidden');
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteAccountModal.classList.add('hidden');
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            deleteUserAccount();
        });

        retryDeleteBtn.addEventListener('click', () => {
            deleteUserAccount();
        });

        function showReauthOptions() {
            if (!currentUser) return;
            reauthSection.classList.remove('hidden');
            const providers = (currentUser.providerData || []).map(p => p.providerId);
            if (providers.includes('password') || currentUser.email) {
                reauthPasswordContainer.classList.remove('hidden');
            } else {
                reauthPasswordContainer.classList.add('hidden');
            }
            if (providers.includes('google.com')) {
                reauthGoogleBtn.classList.remove('hidden');
            } else {
                reauthGoogleBtn.classList.add('hidden');
            }
        }

        reauthPasswordBtn?.addEventListener('click', async () => {
            if (!currentUser) return;
            const pwd = reauthPasswordInput.value.trim();
            if (!pwd || !currentUser.email) {
                deleteError.textContent = 'Enter your password to reauthenticate.';
                return;
            }
            try {
                const cred = EmailAuthProvider.credential(currentUser.email, pwd);
                await reauthenticateWithCredential(currentUser, cred);
                deleteError.textContent = 'Reauthentication successful. Retrying deletion...';
                await deleteUserAccount();
            } catch (e) {
                console.error('Password reauth failed', e);
                deleteError.textContent = `Reauthentication failed: ${e.message}`;
            }
        });

        reauthGoogleBtn?.addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                await reauthenticateWithPopup(currentUser, new GoogleAuthProvider());
                deleteError.textContent = 'Reauthentication successful. Retrying deletion...';
                await deleteUserAccount();
            } catch (e) {
                console.error('Google reauth failed', e);
                deleteError.textContent = `Reauthentication failed: ${e.message}`;
            }
        });
        
        async function deleteUserAccount() {
            const user = auth.currentUser;
            if (!user || !currentUserProfile) return;
            
            confirmDeleteBtn.disabled = true;
            deleteError.textContent = 'Deleting account... (1/6) Removing likes and comments';

            try {
                // Remove likes and comments across the app
                await removeUserLikedPostsAndAdjustCounters(user.uid);
                await removeUserCommentsAndAdjustCounters(user.uid);

                deleteError.textContent = 'Deleting account... (2/6) Deleting your posts';
                await deleteUserPostsAndSubcollections(user.uid);

                deleteError.textContent = 'Deleting account... (3/6) Cleaning your follow graph';
                await removeFollowGraphs(user.uid);

                deleteError.textContent = 'Deleting account... (4/6) Scrubbing your direct messages';
                await scrubDirectMessagesForUser(user.uid);

                deleteError.textContent = 'Deleting account... (5/6) Removing profile';
                await deleteDoc(doc(db, "users", user.uid));

                // Remove username reservation
                await deleteDoc(doc(db, "usernames", currentUserProfile.username));

                // Delete user's auth record
                // This is the sensitive part that might fail
                deleteError.textContent = 'Deleting account... (6/6) Removing authentication record';
                await deleteUser(user);
                
                // Success. onAuthStateChanged will handle the UI redirect.
                deleteAccountModal.classList.add('hidden');
                
            } catch (error) {
                console.error("Delete Account Error:", error);
                if (error.code === 'auth/requires-recent-login') {
                    deleteError.textContent = 'Sensitive action requires recent login. Please reauthenticate below.';
                    showReauthOptions();
                } else {
                    deleteError.textContent = `Error: ${error.message}`;
                }
                confirmDeleteBtn.disabled = false;
            }
        }
        
        // --- 14. EVENT LISTENERS (DOM LOADED) ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded. Attaching nav listeners.");

            // Sidebar links
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    
                    if (targetId === 'content-profile') {
                        showProfile(currentUser.uid);
                    } else {
                        navigateTo(targetId);
                    }
                });
            });

            // Bottom nav links
            bottomNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    
                    if (targetId === 'content-profile') {
                        showProfile(currentUser.uid);
                    } else {
                        navigateTo(targetId);
                    }
                });
            });

            sidebarPostButton.addEventListener('click', () => {
                navigateTo('content-home');
                postTextarea.focus();
            });

            sidebarProfileButton.addEventListener('click', () => {
                showProfile(currentUser.uid);
            });
            
            // Pagination Listeners
            homeLoadMoreBtn.addEventListener('click', () => {
                if(currentUser) loadFollowingFeed(currentUser.uid, true);
            });
            discoverLoadMoreBtn.addEventListener('click', () => {
                loadDiscoverFeed(true);
            });
            profileLoadMoreBtn.addEventListener('click', () => {
                const userId = profileUid.textContent; // Get current profile user's ID
                if(userId) loadProfileFeed(userId, true);
            });
            
            // NEW: Discover filter dropdown listener
            if (discoverFilterSelect) {
                // Sync initial value
                discoverFilterSelect.value = currentDiscoverFilter;
                discoverFilterSelect.addEventListener('change', (e) => {
                    const selected = e.target.value;
                    if (!selected || selected === currentDiscoverFilter) return;
                    currentDiscoverFilter = selected;
                    loadDiscoverFeed(false);
                });
            }

            // Attempt Canvas auth after DOM is loaded
            attemptCanvasAuth();
        });

    </script>

    <script>
    // Fallback error display
    function showInlineError(msg, targetId) {
      const id = targetId || 'auth-error';
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
      } else {
        console.error('Error:', msg);
      }
    }
    </script>
</body>
</html>
