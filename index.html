<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniSocial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple animation for new posts */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Style for a liked button */
        .liked-button {
            color: #EF4444; /* red-500 */
        }
        .liked-button svg {
            fill: #EF4444;
        }

        /* Active state for bottom nav */
        .bottom-nav-link.active {
            color: #4F46E5; /* indigo-600 */
        }
        
        /* Active state for filter tabs */
        .filter-link.active {
            border-color: #4F46E5; /* indigo-600 */
            background-color: #EEF2FF; /* indigo-50 */
            color: #4338CA; /* indigo-700 */
            font-weight: 600;
        }

        /* Mobile message UI layout control */
        @media (max-width: 767px) {
            /* By default, show the list */
            #content-messages.mobile-chat-list #dm-list-container {
                display: flex;
            }
            #content-messages.mobile-chat-list #dm-chat-container,
            #content-messages.mobile-chat-list #dm-placeholder-container {
                display: none;
            }

            /* When in chat view, show the chat */
            #content-messages.mobile-chat-view #dm-list-container {
                display: none;
            }
            #content-messages.mobile-chat-view #dm-chat-container {
                display: flex;
            }
            #content-messages.mobile-chat-view #dm-placeholder-container {
                display: none;
            }
        }
        
        /* NEW: Hide file inputs */
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
    </style>
<style>.meta-counts{display:none !important;}</style>
</head>
<body class="bg-slate-100 font-sans">

    <!-- Auth Container -->
    <div id="auth-container" class="container mx-auto max-w-md p-6 mt-10 md:mt-20 bg-white rounded-lg shadow-xl">
        <div id="auth-error" class="text-red-600 text-sm mb-4" role="alert"></div>
        <h1 class="text-4xl font-bold text-indigo-600 text-center mb-6">MiniSocial</h1>
        
        <form id="signup-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Create Account</h2>
            <div>
                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Sign Up</button>
        </form>

        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/f lg:w-1/4"></span>
        </div>

        <form id="login-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Log In</h2>
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-200">Log In</button>
        </form>
        
        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/5 lg:w-1/4"></span>
        </div>

        <button id="google-signin" class="w-full flex items-center justify-center space-x-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            <span>Sign in with Google</span>
        </button>
    </div>

    <!-- Username Modal -->
    <div id="username-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4">Create your profile</h2>
            <p class="text-gray-600 mb-4">You need a unique username to continue.</p>
            <div id="username-error" class="text-red-600 text-sm mb-4" role="alert"></div>
            <form id="username-form">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">@</span>
                        <input type="text" id="username-input" required placeholder="your_username" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300">
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Save and Enter</button>
            </form>
        </div>
    </div>

    <!-- Account Deletion Modal -->
    <div id="delete-account-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Delete Account</h2>
            <p class="text-gray-600 mb-4">Are you sure you want to delete your account? This action is permanent and cannot be undone. All your profile data will be removed.</p>
            <div id="delete-error" class="text-red-600 text-sm mb-4" role="alert"></div>
            <!-- Reauthentication Section (shown only if needed) -->
            <div id="reauth-section" class="hidden space-y-3 border-t pt-4 mt-4">
                <p id="reauth-hint" class="text-sm text-gray-700">For security, please reauthenticate and try again.</p>

                <div id="reauth-password-container" class="space-y-2 hidden">
                    <label for="reauth-password-input" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                    <input id="reauth-password-input" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your password">
                    <button id="reauth-password-btn" class="w-full bg-slate-800 text-white font-semibold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-200">Reauthenticate with Password</button>
                </div>
                <button id="reauth-google-btn" class="hidden w-full flex items-center justify-center space-x-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    <span>Reauthenticate with Google</span>
                </button>
                <button id="retry-delete-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-full hover:bg-red-700 transition duration-200">Retry Delete</button>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-full hover:bg-gray-300 transition duration-200">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-full hover:bg-red-700 transition duration-200">
                    Confirm Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden container mx-auto max-w-7xl p-4 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Sidebar (Desktop-only) -->
        <aside class="hidden md:block md:col-span-1 md:sticky top-6 h-screen">
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-6">
                <h1 class="text-3xl font-bold text-indigo-600">MiniSocial</h1>

                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" data-target="content-home" class="nav-link flex items-center space-x-3 text-lg font-semibold text-gray-800 p-2 rounded-lg bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-discover" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 10V7m0 10l-6-3" /></svg>
                                <span>Discover</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-notifications" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                                <span>Notifications</span>
                                <span id="notif-badge-desktop" class="ml-2 hidden text-xs bg-red-600 text-white rounded-full px-2">0</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-link-profile" data-target="content-profile" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-search" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16l-3.5 3.5M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                <span>Search</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-messages" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                <span>Messages</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-settings" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <button id="sidebar-post-button" class="w-full bg-indigo-600 text-white font-bold text-lg py-3 rounded-full hover:bg-indigo-700 transition duration-200">
                    Post
                </button>

                <div class="border-t pt-4 mt-6">
                    <div id="sidebar-profile-button" class="flex items-center space-x-3 cursor-pointer rounded-lg p-2 -ml-2 hover:bg-slate-100">
                        <!-- NEW: data-avatar-uid attribute to update this specific image -->
                        <img id="user-avatar" data-avatar-uid="sidebar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <div>
                            <p id="user-displayname" class="font-semibold text-gray-800">Your Name</p>
                            <p id="user-handle" class="text-sm text-gray-500">@yourhandle</p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full mt-4 text-sm text-center text-gray-600 hover:text-indigo-600">Log Out</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="col-span-1 md:col-span-2 space-y-6 pb-20 md:pb-0">

            <!-- Home Panel -->
            <div id="content-home" class="content-panel space-y-6">
                <!-- Hide post box on mobile, it's replaced by the new post panel -->
                <div class="bg-white p-4 rounded-lg shadow-sm hidden md:block">
                    <div class="flex items-start space-x-3">
                        <!-- NEW: data-avatar-uid attribute -->
                        <img id="post-user-avatar" data-avatar-uid="desktop-post" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <textarea id="post-textarea" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="What's happening?"></textarea>
                    </div>
                    
                    <!-- NEW: Image Preview Area -->
                    <div id="post-image-preview-container" class="hidden mt-3 ml-12 relative w-32">
                        <img id="post-image-preview" src="#" alt="Image preview" class="rounded-lg max-w-full h-auto">
                        <button id="post-remove-image-btn" class="absolute -top-2 -right-2 bg-gray-800 text-white rounded-full h-6 w-6 flex items-center justify-center text-sm font-bold">&times;</button>
                    </div>
                    
                    <div id="post-error" class="text-red-600 text-sm mt-2 text-right" role="alert"></div>
                    <div class="flex justify-between items-center mt-3">
                        <!-- NEW: Image Upload Button -->
                        <div>
                            <input type="file" id="post-file-input" class="hidden-file-input" accept="image/*">
                            <label for="post-file-input" class="ml-12 text-indigo-600 hover:text-indigo-800 cursor-pointer p-2 rounded-full hover:bg-indigo-100" title="Add image">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </label>
                        </div>
                        <button id="post-button" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                            Post
                        </button>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 px-2 md:px-0">Your Home Feed</h2>
                <div id="feed-container-home" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="home-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Discover Panel -->
            <div id="content-discover" class="content-panel hidden space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-800">Discover All Posts</h2>
                    
                    <!-- Filter dropdown -->
                    <div class="mt-4">
                        <label for="discover-filter-select" class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                        <select id="discover-filter-select" class="w-full md:w-auto border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="new">New</option>
                            <option value="popular">Popular</option>
                            <option value="likes">Most Likes</option>
                            <option value="comments">Most Comments</option>
                        </select>
                    </div>
                </div>

                <div id="feed-container-discover" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="discover-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Profile Panel -->
            <div id="content-profile" class="content-panel hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <!-- NEW: Avatar upload logic -->
                            <div class="relative group">
                                <img id="profile-page-avatar" data-avatar-uid="profile-page" src="https://placehold.co/80x80/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
                                <label for="avatar-file-input" id="avatar-change-overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 rounded-full items-center justify-center cursor-pointer group-hover:flex">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </label>
                                <input type="file" id="avatar-file-input" class="hidden-file-input" accept="image/*">
                            </div>
                            <!-- End Avatar upload logic -->
                            <div>
                                <h2 id="profile-page-username" class="text-3xl font-bold text-gray-900">Username</h2>
                                <p id="profile-page-handle" class="text-lg text-gray-500">@handle</p>
                            </div>
                        </div>
                        <button id="profile-follow-button" class="hidden mt-4 sm:mt-0 w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-200">
                            Follow
                        </button>
                    </div>
                    <div id="avatar-upload-status" class="text-sm mt-2" role="alert"></div>
                    <div class="flex space-x-6 mt-6 border-t pt-4">
                        <div>
                            <span id="profile-following-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Following</span>
                        </div>
                        <div>
                            <span id="profile-followers-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Followers</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="font-medium">User ID:</p>
                        <p id="profile-page-uid" class="text-gray-500 text-sm break-all"></p>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Posts</h3>
                <div id="profile-feed-container" class="space-y-6">
                    <!-- Posts loaded here -->
                </div>
                <!-- PAGINATION BUTTON -->
                <div class="p-4 flex justify-center">
                    <button id="profile-load-more" class="hidden bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Messages Panel -->
            <div id="content-messages" class="content-panel hidden bg-white rounded-lg shadow-sm h-screen md:h-[80vh] mobile-chat-list">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    
                    <div id="dm-list-container" class="md:col-span-1 border-r border-gray-200 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 p-4 border-b">Conversations</h2>
                        <div id="dm-conversation-list" class="flex-1 overflow-y-auto">
                            <p class="p-4 text-gray-500">Loading conversations...</p>
                        </div>
                    </div>
                    
                    <div id="dm-chat-container" class="md:col-span-2 h-full flex flex-col hidden">
                        <div id="dm-chat-header-bar" class="flex items-center p-4 border-b">
                            <button id="dm-back-btn" class="md:hidden p-1 mr-2 text-gray-600 hover:text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 id="dm-chat-header" class="text-xl font-semibold text-gray-800">Select a conversation</h2>
                        </div>
                        
                        <div id="message-log" class="flex-1 p-4 space-y-4 overflow-y-auto bg-slate-50">
                        </div>
                        
                        <form id="dm-form" class="p-4 border-t flex space-x-3 bg-white">
                            <input type="text" id="dm-input" placeholder="Select a conversation to message..." class="flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" disabled>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200" disabled>Send</button>
                        </form>
                    </div>

                    <div id="dm-placeholder-container" class="md:col-span-2 h-full md:flex items-center justify-center bg-slate-50 hidden">
                         <p class="text-gray-500">Select a conversation to start chatting.</p>
                    </div>

                </div>
            </div>

            <!-- Full-screen Post Panel (for mobile) -->
            <div id="content-post" class="content-panel hidden space-y-4 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">New Post</h2>
                    <button id="post-cancel-button" class="text-gray-600 hover:text-indigo-600 font-medium">Cancel</button>
                </div>
                <div class="flex items-start space-x-3">
                    <!-- NEW: data-avatar-uid attribute -->
                    <img id="post-panel-user-avatar" data-avatar-uid="mobile-post" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <textarea id="post-panel-textarea" class="w-full p-2 text-lg border-0 rounded-lg focus:outline-none focus:ring-0" rows="8" placeholder="What's happening?"></textarea>
                </div>
                
                <!-- NEW: Image Preview Area (Mobile) -->
                <div id="post-panel-image-preview-container" class="hidden mt-3 ml-12 relative w-32">
                    <img id="post-panel-image-preview" src="#" alt="Image preview" class="rounded-lg max-w-full h-auto">
                    <button id="post-panel-remove-image-btn" class="absolute -top-2 -right-2 bg-gray-800 text-white rounded-full h-6 w-6 flex items-center justify-center text-sm font-bold">&times;</button>
                </div>

                <div id="post-panel-error" class="text-red-600 text-sm mt-2 text-right" role="alert"></div>
                <div class="flex justify-between items-center mt-3">
                    <!-- NEW: Image Upload Button (Mobile) -->
                    <div>
                        <input type="file" id="post-panel-file-input" class="hidden-file-input" accept="image/*">
                        <label for="post-panel-file-input" class="ml-12 text-indigo-600 hover:text-indigo-800 cursor-pointer p-2 rounded-full hover:bg-indigo-100" title="Add image">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </label>
                    </div>
                    <button id="post-panel-button" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                        Post
                    </button>
                </div>
            </div>

            <!-- Search Panel -->
            <div id="content-search" class="content-panel hidden bg-white p-6 rounded-lg shadow-sm space-y-4">
                <div class="flex items-center space-x-3">
                    <div class="flex-1">
                        <input id="search-input" type="text" placeholder="Search for users or posts..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" name="no-autofill-search" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                    </div>
                    <button id="search-clear" class="px-3 py-2 rounded border text-gray-700 hover:bg-gray-50">Clear</button>
                </div>
                <div class="flex space-x-2">
                    <button id="search-tab-users" class="px-3 py-1 rounded-full border bg-indigo-600 text-white">Users</button>
                    <button id="search-tab-posts" class="px-3 py-1 rounded-full border text-gray-700">Posts</button>
                </div>
                <div id="search-results" class="space-y-3">
                    <p class="text-gray-500">Type to search.</p>
                </div>
            </div>
            
            <!-- Settings Panel -->
            <div id="content-settings" class="content-panel hidden bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
                
                <div class="space-y-4">
                    <!-- NEW: Avatar in settings -->
                    <div class="flex items-center space-x-4">
                        <div class="relative group">
                            <img id="settings-page-avatar" data-avatar-uid="settings-page" src="https://placehold.co/64x64/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-white shadow-md">
                            <label for="avatar-file-input-settings" id="avatar-change-overlay-settings" class="hidden absolute inset-0 bg-black bg-opacity-50 rounded-full items-center justify-center cursor-pointer group-hover:flex">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </label>
                            <input type="file" id="avatar-file-input-settings" class="hidden-file-input" accept="image/*">
                        </div>
                        <div>
                            <p class="font-medium">Your Avatar</p>
                            <p id="avatar-upload-status-settings" class="text-sm text-gray-500" role="alert">Click image to change</p>
                        </div>
                    </div>
                    <div>
                        <p class="font-medium">Your Email:</p>
                        <p id="settings-email" class="text-gray-700"></p>
                    </div>
                    <div>
                        <p class="font-medium">Your Username:</p>
                        <p id="settings-username" class="text-gray-700"></p>
                    </div>
                    <!-- Mobile-visible logout -->
                    <div class="md:hidden">
                        <button id="mobile-logout-button" class="mt-2 w-full border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">Log Out</button>
                    </div>
                </div>

                <!-- Delete Account Section -->
                <div class="mt-8 pt-6 border-t border-red-200">
                    <h3 class="text-xl font-bold text-red-600">Delete Account</h3>
                    <p class="text-gray-600 mt-2">Permanently delete your account and all associated data. This action cannot be undone.</p>
                    <button id="delete-account-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-6 rounded-full hover:bg-red-700 transition duration-200">
                        Delete Your Account
                    </button>
                </div>
            </div>

            <!-- Notifications Panel -->
            <div id="content-notifications" class="content-panel hidden bg-white p-6 rounded-lg shadow-sm space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800">Notifications</h2>
                    <button id="notif-mark-all" class="text-sm px-3 py-1 rounded border text-gray-700 hover:bg-gray-50">Mark all as read</button>
                </div>
                <div id="notif-list" class="divide-y divide-gray-200">
                    <p class="text-gray-500">No notifications yet.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Bottom Navigation Bar (Mobile-only) -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 flex justify-around items-center z-40">
        <a href="#" data-target="content-home" class="bottom-nav-link p-2 text-gray-600 active">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
        </a>
        <a href="#" data-target="content-discover" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 10V7m0 10l-6-3" /></svg>
        </a>
        <!-- This new link opens the post panel -->
        <a href="#" data-target="content-post" class="bottom-nav-link p-2 text-white bg-indigo-600 rounded-full shadow-lg">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        </a>
        <a href="#" data-target="content-messages" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        </a>
        <a href="#" id="bottom-nav-profile-link" data-target="content-profile" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </a>
        <!-- Settings link for mobile -->
        <a href="#" data-target="content-settings" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </a>
        <!-- Search link for mobile -->
        <a href="#" data-target="content-search" class="bottom-nav-link p-2 text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16l-3.5 3.5M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </a>
        <!-- Notifications link for mobile -->
        <a href="#" data-target="content-notifications" class="bottom-nav-link p-2 text-gray-600 relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            <span id="notif-badge-mobile" class="absolute -top-1 -right-2 hidden text-[10px] bg-red-600 text-white rounded-full px-1">0</span>
        </a>
    </nav>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            deleteUser,
            reauthenticateWithPopup,
            reauthenticateWithCredential,
            EmailAuthProvider,
            updateProfile // NEW: Import updateProfile for avatar
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            getDocs,
            collectionGroup,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot, 
            serverTimestamp, 
            runTransaction,
            where,
            increment,
            writeBatch,
            limit,
            updateDoc,
            startAfter,
            deleteDoc,
            deleteField
        } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';
        // NEW: Import Storage
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // --- 1. FIREBASE CONFIGURATION ---
        
        // Load config from global var or use your provided fallback
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // THIS IS YOUR CONFIG BLOCK:
                apiKey: "AIzaSyD-47gtfyUV75JPV03nqoMle4URzFK2B3E",
                authDomain: "nety-a602c.firebaseapp.com",
                projectId: "nety-a602c",
                storageBucket: "nety-a602c.firebasestorage.app",
                messagingSenderId: "874189944569",
                appId: "1:874189944569:web:d254db7f3841cf0ad2d428",
                measurementId: "G-6SE8GF9MD0"
              };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // NEW: Initialize Storage
        let analytics = null;
        try { analytics = getAnalytics(app); } catch (_) { analytics = null; }

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let currentUserProfile = null;
        let currentUserLikedPosts = new Set();
        
        let homeLastVisible = null;
        let discoverLastVisible = null;
        let profileLastVisible = null;
        let isLoadingHome = false;
        let isLoadingDiscover = false;
        let isLoadingProfile = false;
        
        let currentChatPartner = null;
        let unsubscribeConversation = null;
        let unsubscribeNotifications = null;

        let currentDiscoverFilter = 'new';
        let likeOpsInFlight = new Set();
        
        // NEW: Store selected post image file
        let selectedPostFile = null;
        let selectedPostPanelFile = null;

        // --- 3. DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const usernameModal = document.getElementById('username-modal');

        // Auth Forms
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const googleSigninBtn = document.getElementById('google-signin');
        const logoutButton = document.getElementById('logout-button');
        const mobileLogoutButton = document.getElementById('mobile-logout-button');
        const authError = document.getElementById('auth-error');

        // Username Modal
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');
        const usernameError = document.getElementById('username-error');

        // Main App
        const postButton = document.getElementById('post-button');
        const postTextarea = document.getElementById('post-textarea');
        const postError = document.getElementById('post-error');
        const homeFeedContainer = document.getElementById('feed-container-home');
        const discoverFeedContainer = document.getElementById('feed-container-discover');
        
        // NEW: Post Image Elements (Desktop)
        const postFileInput = document.getElementById('post-file-input');
        const postImagePreviewContainer = document.getElementById('post-image-preview-container');
        const postImagePreview = document.getElementById('post-image-preview');
        const postRemoveImageBtn = document.getElementById('post-remove-image-btn');

        // Post Panel (for mobile)
        const postPanel = document.getElementById('content-post');
        const postPanelTextarea = document.getElementById('post-panel-textarea');
        const postPanelButton = document.getElementById('post-panel-button');
        const postPanelError = document.getElementById('post-panel-error');
        const postPanelCancel = document.getElementById('post-cancel-button');
        const postPanelAvatar = document.getElementById('post-panel-user-avatar');
        
        // NEW: Post Image Elements (Mobile)
        const postPanelFileInput = document.getElementById('post-panel-file-input');
        const postPanelImagePreviewContainer = document.getElementById('post-panel-image-preview-container');
        const postPanelImagePreview = document.getElementById('post-panel-image-preview');
        const postPanelRemoveImageBtn = document.getElementById('post-panel-remove-image-btn');

        // Load More Buttons
        const homeLoadMoreBtn = document.getElementById('home-load-more');
        const discoverLoadMoreBtn = document.getElementById('discover-load-more');
        const profileLoadMoreBtn = document.getElementById('profile-load-more');
        
        // DM Elements
        const dmContentPanel = document.getElementById('content-messages'); 
        const dmConversationList = document.getElementById('dm-conversation-list');
        const dmChatView = document.getElementById('dm-chat-container'); 
        const dmChatPlaceholder = document.getElementById('dm-placeholder-container'); 
        const dmChatHeader = document.getElementById('dm-chat-header');
        const dmForm = document.getElementById('dm-form');
        const dmInput = document.getElementById('dm-input');
        const dmFormButton = dmForm.querySelector('button[type="submit"]');
        const messageLog = document.getElementById('message-log');
        const dmBackButton = document.getElementById('dm-back-btn'); 

        // UI Elements
        const userAvatar = document.getElementById('user-avatar');
        const postUserAvatar = document.getElementById('post-user-avatar');
        const userDisplayname = document.getElementById('user-displayname');
        const userHandle = document.getElementById('user-handle');
        const sidebarProfileButton = document.getElementById('sidebar-profile-button');

        // Profile Page Elements
        const profilePage = document.getElementById('content-profile');
        const profileAvatar = document.getElementById('profile-page-avatar');
        const profileUsername = document.getElementById('profile-page-username');
        const profileHandle = document.getElementById('profile-page-handle');
        const profileFollowButton = document.getElementById('profile-follow-button');
        let profileMessageButton = null;
        const profileFollowingCount = document.getElementById('profile-following-count');
        const profileFollowersCount = document.getElementById('profile-followers-count');
        const profileUid = document.getElementById('profile-page-uid');
        const profileFeedContainer = document.getElementById('profile-feed-container');
        // NEW: Avatar Upload Elements
        const avatarFileInput = document.getElementById('avatar-file-input');
        const avatarChangeOverlay = document.getElementById('avatar-change-overlay');
        const avatarUploadStatus = document.getElementById('avatar-upload-status');

        // Settings Page Elements
        const settingsEmail = document.getElementById('settings-email');
        const settingsUsername = document.getElementById('settings-username');
        // NEW: Settings Avatar Upload
        const settingsAvatarInput = document.getElementById('avatar-file-input-settings');
        const settingsAvatarStatus = document.getElementById('avatar-upload-status-settings');
        const settingsAvatarImg = document.getElementById('settings-page-avatar');
        
        // Notifications Elements
        const notifList = document.getElementById('notif-list');
        const notifMarkAllBtn = document.getElementById('notif-mark-all');
        const notifBadgeDesktop = document.getElementById('notif-badge-desktop');
        const notifBadgeMobile = document.getElementById('notif-badge-mobile');

        // Search Elements
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear');
        const searchTabUsers = document.getElementById('search-tab-users');
        const searchTabPosts = document.getElementById('search-tab-posts');
        const searchResults = document.getElementById('search-results');
        let searchActiveTab = 'users';
        
        // Delete Account Elements
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteError = document.getElementById('delete-error');
        const reauthSection = document.getElementById('reauth-section');
        const reauthHint = document.getElementById('reauth-hint');
        const reauthPasswordContainer = document.getElementById('reauth-password-container');
        const reauthPasswordInput = document.getElementById('reauth-password-input');
        const reauthPasswordBtn = document.getElementById('reauth-password-btn');
        const reauthGoogleBtn = document.getElementById('reauth-google-btn');
        const retryDeleteBtn = document.getElementById('retry-delete-btn');
        
        // Discover Filter Elements
        const discoverFilterSelect = document.getElementById('discover-filter-select');
        
        // --- 4. AUTH STATE CONTROLLER ---

        async function attemptCanvasAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error("Canvas custom token sign-in failed:", error);
                }
            }
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkUserProfile(user);
            } else {
                currentUser = null;
                currentUserProfile = null;
                showAuthUI();
            }
        });

        async function checkUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                currentUserProfile = docSnap.data();
                // NEW: Ensure profile.photoURL is synced with auth.photoURL if it's missing
                if (user.photoURL && !currentUserProfile.photoURL) {
                    currentUserProfile.photoURL = user.photoURL;
                    // Best-effort update, don't block UI
                    updateDoc(userRef, { photoURL: user.photoURL }).catch(() => {});
                }
                await initializeAppUI(user, currentUserProfile);
            } else {
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                usernameModal.classList.remove('hidden');
            }
        }

        function showAuthUI() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            deleteAccountModal.classList.add('hidden');
            if (bottomNav) bottomNav.classList.add('hidden');
            
            homeLastVisible = null;
            discoverLastVisible = null;
            profileLastVisible = null;
            
            if (unsubscribeConversation) unsubscribeConversation();
            currentChatPartner = null;
            if (typeof unsubscribeNotifications === 'function') { unsubscribeNotifications(); unsubscribeNotifications = null; }
            const resetBadge = (el) => { if (el) { el.classList.add('hidden'); el.textContent = '0'; } };
            resetBadge(notifBadgeDesktop);
            resetBadge(notifBadgeMobile);
        }
        
        // NEW: Helper to update all user avatars in the UI
        function updateAllAvatars(newUrl) {
            const defaultAvatar = `https://placehold.co/40x40/E0E7FF/4F46E5?text=${(currentUserProfile.username || 'U').charAt(0).toUpperCase()}`;
            const url = newUrl || defaultAvatar;
            
            // Find all img tags with data-avatar-uid attribute
            const avatarImages = document.querySelectorAll('img[data-avatar-uid]');
            avatarImages.forEach(img => {
                img.src = url;
            });
            
            // Update profile page avatar specifically (it has a different size)
            if (profileAvatar) {
                profileAvatar.src = newUrl || `https://placehold.co/80x80/E0E7FF/4F46E5?text=${(currentUserProfile.username || 'U').charAt(0).toUpperCase()}`;
            }
            if (settingsAvatarImg) {
                settingsAvatarImg.src = newUrl || `https://placehold.co/64x64/E0E7FF/4F46E5?text=${(currentUserProfile.username || 'U').charAt(0).toUpperCase()}`;
            }
        }

        async function initializeAppUI(user, profile) {
            userDisplayname.textContent = profile.username;
            userHandle.textContent = `@${profile.username}`;
            
            // NEW: Use profile.photoURL as the source of truth
            const avatarUrl = profile.photoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            // NEW: Use helper function
            updateAllAvatars(profile.photoURL);

            settingsEmail.textContent = user.email || 'Not provided';
            settingsUsername.textContent = `@${profile.username}`;
            
            await loadUserLikedPosts(user.uid);

            authContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            if (bottomNav) bottomNav.classList.remove('hidden');
            navigateTo("content-home");

            loadFollowingFeed(user.uid, false);
            loadDiscoverFeed(false);
            startNotificationsListener(user.uid);
        }

        // --- 5. AUTHENTICATION FUNCTIONS ---

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                signupForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Signup Error:", error);
                authError.textContent = error.message;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Login Error:", error);
                authError.textContent = error.message;
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                authError.textContent = '';
            } catch (error) {
                console.error("Google Signin Error:", error);
                authError.textContent = error.message;
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });
        mobileLogoutButton?.addEventListener('click', () => {
            signOut(auth);
        });

        // --- 6. USERNAME CREATION ---

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim().toLowerCase();
            if (username.length < 3) {
                usernameError.textContent = 'Username must be at least 3 characters.';
                return;
            }
            if (!/^[a-z0-9_]+$/.test(username)) {
                usernameError.textContent = 'Username can only contain lowercase letters, numbers, and underscores.';
                return;
            }

            const user = auth.currentUser;
            const usernameRef = doc(db, 'usernames', username);
            const userRef = doc(db, 'users', user.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const usernameDoc = await transaction.get(usernameRef);
                    if (usernameDoc.exists()) {
                        throw new Error("This username is already taken.");
                    }
                    
                    transaction.set(usernameRef, { uid: user.uid });
                    
                    const newUserProfile = {
                        username: username,
                        email: user.email || '',
                        uid: user.uid,
                        createdAt: serverTimestamp(),
                        photoURL: user.photoURL || '', // NEW: Save initial photoURL
                        followingCount: 0,
                        followersCount: 0
                    };
                    transaction.set(userRef, newUserProfile);
                    
                    currentUserProfile = newUserProfile;
                });

                usernameError.textContent = '';
                await initializeAppUI(user, currentUserProfile);

            } catch (error) {
                console.error("Username Save Error:", error);
                usernameError.textContent = error.message;
            }
        });

        // --- 7. POSTING (FIRESTORE & STORAGE) ---

        // NEW: Generic image upload function
        async function uploadImage(file, path) {
            const storageRef = ref(storage, path);
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        }

        // Generic function to create a post
        async function createPost(text, imageFile, onStart, onSuccess, onError) {
            onStart(); // Disable button, clear errors
            const postText = text.trim(); 

            if (postText.length > 1000) {
                onError('Post is too long (max 1000 chars).');
                return;
            }
            if (!postText && !imageFile) { // NEW: Check for image
                onError('Post cannot be empty.');
                return;
            }
            
            if (currentUser && currentUserProfile) {
                try {
                    let imageUrl = null;
                    // NEW: Upload image if one exists
                    if (imageFile) {
                        const fileExt = imageFile.name.split('.').pop();
                        const fileName = `${Date.now()}.${fileExt}`;
                        const path = `posts/${currentUser.uid}/${fileName}`;
                        imageUrl = await uploadImage(imageFile, path);
                    }
                    
                    const newPostData = {
                        text: postText,
                        imageUrl: imageUrl, // NEW: Add image URL
                        userId: currentUser.uid,
                        username: currentUserProfile.username,
                        userPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile photoURL
                        createdAt: serverTimestamp(),
                        likeCount: 0,
                        commentCount: 0,
                        popularityScore: 0,
                        edited: false
                    };
                    
                    const docRef = await addDoc(collection(db, "posts"), newPostData);
                    
                    const postElement = createPostElement(docRef.id, {
                        ...newPostData,
                        createdAt: { toDate: () => new Date() }
                    });
                    homeFeedContainer.prepend(postElement);
                    
                    onSuccess(); // Clear textarea, etc.

                } catch (error) {
                    console.error("Post Error:", error);
                    onError(`Error creating post: ${error.message}`);
                }
            }
        }

        // Desktop post button
        postButton.addEventListener('click', () => {
            createPost(
                postTextarea.value,
                selectedPostFile, // NEW: Pass file
                () => { // onStart
                    postButton.disabled = true;
                    postError.textContent = '';
                },
                () => { // onSuccess
                    postTextarea.value = '';
                    postError.textContent = '';
                    postButton.disabled = false;
                    resetPostImagePreview(); // NEW: Clear preview
                },
                (err) => { // onError
                    postError.textContent = err;
                    postButton.disabled = false;
                }
            );
        });

        // Mobile post panel button
        postPanelButton.addEventListener('click', () => {
            createPost(
                postPanelTextarea.value,
                selectedPostPanelFile, // NEW: Pass file
                () => { // onStart
                    postPanelButton.disabled = true;
                    postPanelError.textContent = '';
                },
                () => { // onSuccess
                    postPanelTextarea.value = '';
                    postPanelError.textContent = '';
                    postPanelButton.disabled = false;
                    resetPostPanelImagePreview(); // NEW: Clear preview
                    navigateTo('content-home');
                },
                (err) => { // onError
                    postPanelError.textContent = err;
                    postPanelButton.disabled = false;
                }
            );
        });
        
        postPanelCancel.addEventListener('click', () => {
            postPanelTextarea.value = '';
            postPanelError.textContent = '';
            resetPostPanelImagePreview(); // NEW: Clear preview
            navigateTo('content-home');
        });

        // --- 7.5. POST IMAGE PREVIEW LOGIC ---
        
        function handlePostImageSelect(event, isPanel) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('Image is too large. Max 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (isPanel) {
                        postPanelImagePreview.src = e.target.result;
                        postPanelImagePreviewContainer.classList.remove('hidden');
                        selectedPostPanelFile = file;
                    } else {
                        postImagePreview.src = e.target.result;
                        postImagePreviewContainer.classList.remove('hidden');
                        selectedPostFile = file;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function resetPostImagePreview() {
            postImagePreview.src = '#';
            postImagePreviewContainer.classList.add('hidden');
            postFileInput.value = ''; // Clear file input
            selectedPostFile = null;
        }

        function resetPostPanelImagePreview() {
            postPanelImagePreview.src = '#';
            postPanelImagePreviewContainer.classList.add('hidden');
            postPanelFileInput.value = ''; // Clear file input
            selectedPostPanelFile = null;
        }

        postFileInput.addEventListener('change', (e) => handlePostImageSelect(e, false));
        postRemoveImageBtn.addEventListener('click', resetPostImagePreview);
        
        postPanelFileInput.addEventListener('change', (e) => handlePostImageSelect(e, true));
        postPanelRemoveImageBtn.addEventListener('click', resetPostPanelImagePreview);


        // --- 8. LOADING FEEDS & POSTS (PAGINATION) ---

        const POST_PAGE_SIZE = 10;

        async function loadFeed(feedType, baseQuery, sortConstraint, isLoadMore) {
            let container, loadMoreBtn, lastVisible, isLoading;

            if (feedType === 'home') {
                container = homeFeedContainer;
                loadMoreBtn = homeLoadMoreBtn;
                lastVisible = homeLastVisible;
                isLoading = isLoadingHome;
            } else if (feedType === 'discover') {
                container = discoverFeedContainer;
                loadMoreBtn = discoverLoadMoreBtn;
                lastVisible = discoverLastVisible;
                isLoading = isLoadingDiscover;
            } else { // profile
                container = profileFeedContainer;
                loadMoreBtn = profileLoadMoreBtn;
                lastVisible = profileLastVisible;
                isLoading = isLoadingProfile;
            }

            if (isLoading) return;
            
            if (feedType === 'home') isLoadingHome = true;
            else if (feedType === 'discover') isLoadingDiscover = true;
            else isLoadingProfile = true;

            if (!isLoadMore) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">Loading feed...</p>';
                lastVisible = null;
            }

            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';

            try {
                let queryConstraints = [sortConstraint, limit(POST_PAGE_SIZE)];
                if (isLoadMore && lastVisible) {
                    queryConstraints.push(startAfter(lastVisible));
                }
                
                const finalQuery = query(baseQuery, ...queryConstraints);
                const snapshot = await getDocs(finalQuery);

                if (!isLoadMore) {
                    container.innerHTML = '';
                }

                if (snapshot.empty) {
                    if (!isLoadMore) {
                        if (feedType === 'home') {
                             container.innerHTML = '<p class="text-gray-500 text-center p-4">Follow users to see their posts here. Check out the Discover tab!</p>';
                        } else {
                            container.innerHTML = '<p class="text-gray-500 text-center p-4">No posts found.</p>';
                        }
                    }
                    loadMoreBtn.textContent = 'No more posts';
                    loadMoreBtn.classList.add('hidden');
                } else {
                    snapshot.forEach(doc => {
                        const postElement = createPostElement(doc.id, doc.data());
                        container.appendChild(postElement);
                    });

                    lastVisible = snapshot.docs[snapshot.docs.length - 1];
                    
                    if (snapshot.docs.length < POST_PAGE_SIZE) {
                        loadMoreBtn.textContent = 'No more posts';
                        loadMoreBtn.classList.add('hidden');
                    } else {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Load More';
                        loadMoreBtn.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error(`Error loading ${feedType} feed:`, error);
                container.innerHTML = `<p class="text-red-500 text-center">Error loading feed. ${error.message}</p>`;
            }
            
            if (feedType === 'home') {
                homeLastVisible = lastVisible;
                isLoadingHome = false;
            } else if (feedType === 'discover') {
                discoverLastVisible = lastVisible;
                isLoadingDiscover = false;
            } else {
                profileLastVisible = lastVisible;
                isLoadingProfile = false;
            }
        }
        
        async function loadFollowingFeed(userId, isLoadMore = false) {
            if (!isLoadMore) {
                homeLastVisible = null;
            }
            
            const followingCol = collection(db, "users", userId, "following");
            const followingSnapshot = await getDocs(followingCol);
            
            const followedUserIds = [userId];
            followingSnapshot.forEach(doc => {
                followedUserIds.push(doc.id);
            });

            if (followedUserIds.length <= 10) {
                const baseQuery = query(
                    collection(db, "posts"), 
                    where("userId", "in", followedUserIds)
                );
                await loadFeed('home', baseQuery, orderBy("createdAt", "desc"), isLoadMore);
                return;
            }

            if (isLoadMore) {
                homeLoadMoreBtn.classList.add('hidden');
                return;
            }

            isLoadingHome = true;
            homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Loading feed...</p>';
            homeLoadMoreBtn.classList.add('hidden');

            const chunks = [];
            for (let i = 0; i < followedUserIds.length; i += 10) {
                chunks.push(followedUserIds.slice(i, i + 10));
            }

            try {
                const resultsPerChunk = await Promise.all(chunks.map(async (ids) => {
                    const q = query(
                        collection(db, "posts"),
                        where("userId", "in", ids),
                        orderBy("createdAt", "desc"),
                        limit(POST_PAGE_SIZE)
                    );
                    const snap = await getDocs(q);
                    return snap.docs;
                }));

                const allDocs = Array.from(new Map(
                    resultsPerChunk
                        .flat()
                        .map(d => [d.id, d])
                ).values());

                allDocs.sort((a, b) => {
                    const ad = a.data().createdAt?.toDate ? a.data().createdAt.toDate().getTime() : 0;
                    const bd = b.data().createdAt?.toDate ? b.data().createdAt.toDate().getTime() : 0;
                    return bd - ad;
                });

                const firstPage = allDocs.slice(0, POST_PAGE_SIZE);
                homeFeedContainer.innerHTML = '';
                if (firstPage.length === 0) {
                    homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No posts found.</p>';
                } else {
                    firstPage.forEach(d => {
                        homeFeedContainer.appendChild(createPostElement(d.id, d.data()));
                    });
                }

                const note = document.createElement('p');
                note.className = 'text-xs text-gray-500 text-center mt-2';
                note.textContent = 'Showing recent posts from followed users. For more, use Discover.';
                homeFeedContainer.appendChild(note);

            } catch (error) {
                console.error('Error loading home feed (chunked):', error);
                homeFeedContainer.innerHTML = `<p class="text-red-500 text-center">Error loading feed. ${error.message}</p>`;
            }

            isLoadingHome = false;
        }

        function loadDiscoverFeed(isLoadMore = false) {
            if (!isLoadMore) {
                discoverLastVisible = null;
            }
            
            let sortConstraint;
            switch (currentDiscoverFilter) {
                case 'popular':
                    sortConstraint = orderBy("popularityScore", "desc");
                    break;
                case 'likes':
                    sortConstraint = orderBy("likeCount", "desc");
                    break;
                case 'comments':
                    sortConstraint = orderBy("commentCount", "desc");
                    break;
                case 'new':
                default:
                    sortConstraint = orderBy("createdAt", "desc");
                    break;
            }

            const baseQuery = query(collection(db, "posts"));
            loadFeed('discover', baseQuery, sortConstraint, isLoadMore);
        }

        function loadProfileFeed(userId, isLoadMore = false) {
            if (!isLoadMore) {
                profileLastVisible = null;
            }
            const baseQuery = query(
                collection(db, "posts"), 
                where("userId", "==", userId)
            );
            loadFeed('profile', baseQuery, orderBy("createdAt", "desc"), isLoadMore);
        }
        
        function createPostElement(postId, post) {
            const article = document.createElement('article');
            article.className = 'bg-white p-4 rounded-lg shadow-sm animate-fade-in';
            article.dataset.postId = postId;
            article.dataset.userId = post.userId;

            const date = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleString() : 'Just now';
            // NEW: Use userPhotoURL from post data
            const avatarUrl = post.userPhotoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${post.username.charAt(0).toUpperCase()}`;

            const header = document.createElement('div');
            header.className = 'flex items-start justify-between';
            
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarUrl;
            avatarImg.alt = `${post.username}'s avatar`;
            avatarImg.className = 'w-10 h-10 rounded-full cursor-pointer';
            avatarImg.onclick = () => showProfile(post.userId);

            const meta = document.createElement('div');
            const nameP = document.createElement('p');
            nameP.className = 'font-semibold text-gray-800 cursor-pointer hover:underline';
            nameP.textContent = post.username || 'Unknown';
            nameP.onclick = () => showProfile(post.userId);

            const infoP = document.createElement('p');
            infoP.className = 'text-sm text-gray-500 flex items-center space-x-2';
            infoP.setAttribute('data-role', 'post-meta');
            const infoText = document.createElement('span');
            infoText.textContent = `@${post.username || 'unknown'} · ${date}`;
            infoP.appendChild(infoText);
            if (post.edited) {
                const editedBadge = document.createElement('span');
                editedBadge.className = 'text-xs text-gray-400 border border-gray-200 rounded px-1';
                editedBadge.textContent = 'Edited';
                infoP.appendChild(editedBadge);
            }

            meta.appendChild(nameP);
            meta.appendChild(infoP);
            const leftHeader = document.createElement('div');
            leftHeader.className = 'flex items-center space-x-3';
            leftHeader.appendChild(avatarImg);
            leftHeader.appendChild(meta);

            const actions = document.createElement('div');
            actions.className = 'flex items-center space-x-2';
            if (currentUser && post.userId === currentUser.uid) {
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'p-1 text-gray-400 hover:text-indigo-600';
                editBtn.setAttribute('aria-label', 'Edit post');
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5h2m-8 8l-1 4 4-1 9-9a2.121 2.121 0 10-3-3l-9 9z"/></svg>`;
                editBtn.addEventListener('click', () => enterEditMode(article, postId));

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'p-1 text-gray-400 hover:text-red-600';
                deleteBtn.setAttribute('aria-label', 'Delete post');
                deleteBtn.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"><path stroke-linecap="round" stroke-linejoin="round" d=\"M6 7h12M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2m1 0l-1 12a2 2 0 01-2 2H8a2 2 0 01-2-2L5 7h14\"/></svg>`;
                deleteBtn.addEventListener('click', () => deletePost(article, postId, post.imageUrl)); // NEW: Pass imageUrl

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);
            }

            header.appendChild(leftHeader);
            header.appendChild(actions);
            
            article.appendChild(header);

            // NEW: Add text only if it exists
            if (post.text) {
                const paragraph = document.createElement('p');
                paragraph.className = 'mt-4 text-gray-700 text-lg whitespace-pre-wrap';
                paragraph.textContent = post.text;
                article.appendChild(paragraph);
            }

            // NEW: Add image only if it exists
            if (post.imageUrl) {
                const image = document.createElement('img');
                image.src = post.imageUrl;
                image.alt = 'Post image';
                image.className = 'mt-4 rounded-lg w-full max-w-lg max-h-[600px] object-contain border';
                article.appendChild(image);
            }


            const footer = document.createElement('div');
            footer.className = 'flex justify-around items-center mt-4 pt-3 border-t';

            // Like Button
            const likeBtn = document.createElement('button');
            likeBtn.type = 'button';
            const isLiked = currentUserLikedPosts.has(postId);
            likeBtn.className = `flex items-center space-x-2 text-gray-500 hover:text-red-500 group ${isLiked ? 'liked-button' : ''}`;
            likeBtn.setAttribute('aria-label', 'Like post');
            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>`;
            
            const likeCount = document.createElement('span');
            likeCount.className = 'text-sm like-count';
            likeCount.textContent = post.likeCount || 0;
            likeBtn.appendChild(likeCount);
            
            likeBtn.addEventListener('click', () => {
                const currentlyLiked = currentUserLikedPosts.has(postId);
                toggleLike(postId, currentlyLiked);
            });

            // Comment Button
            const commentBtn = document.createElement('button');
            commentBtn.type = 'button';
            commentBtn.className = 'flex items-center space-x-2 text-gray-500 hover:text-indigo-500 group';
            commentBtn.setAttribute('aria-label', 'Comment on post');
            commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`;
            
            const commentCount = document.createElement('span');
            commentCount.className = 'text-sm comment-count';
            commentCount.textContent = post.commentCount || 0;
            commentBtn.appendChild(commentCount);
            
            commentBtn.addEventListener('click', () => toggleCommentSection(postId));

            footer.appendChild(likeBtn);
            footer.appendChild(commentBtn);

            // Comment Section (initially hidden)
            const commentSection = document.createElement('div');
            commentSection.id = `comments-section-${postId}`;
            commentSection.className = 'hidden mt-4 pt-4 border-t';

            const commentList = document.createElement('div');
            commentList.id = `comments-list-${postId}`;
            commentList.className = 'space-y-3 mb-4 max-h-60 overflow-y-auto';
            
            const commentForm = document.createElement('form');
            commentForm.id = `comment-form-${postId}`;
            commentForm.className = 'flex items-start space-x-3';
            
            const commentAvatar = document.createElement('img');
            commentAvatar.src = userAvatar.src; // Uses the sidebar avatar
            commentAvatar.className = 'w-9 h-9 rounded-full';
            
            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.placeholder = 'Write a comment...';
            commentInput.className = 'flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400';
            commentInput.name = 'commentText';

            const commentSubmitBtn = document.createElement('button');
            commentSubmitBtn.type = 'submit';
            commentSubmitBtn.className = 'bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200';
            commentSubmitBtn.textContent = 'Reply';

            commentForm.appendChild(commentAvatar);
            commentForm.appendChild(commentInput);
            commentForm.appendChild(commentSubmitBtn);

            commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, postId));

            commentSection.appendChild(commentList);
            commentSection.appendChild(commentForm);
            
            article.appendChild(footer);
            article.appendChild(commentSection);

            return article;
        }


        // --- 8.5 POST EDIT/DELETE FUNCTIONS ---

        function enterEditMode(articleEl, postId) {
            // NOTE: Editing images is not supported in this mode.
            const originalPara = articleEl.querySelector('p.mt-4');
            const originalText = originalPara ? originalPara.textContent : '';

            const editor = document.createElement('div');
            editor.className = 'mt-4';

            const textarea = document.createElement('textarea');
            textarea.className = 'w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400';
            textarea.rows = 5;
            textarea.maxLength = 1000;
            textarea.value = originalText;

            const controls = document.createElement('div');
            controls.className = 'mt-2 flex items-center justify-between';

            const counter = document.createElement('span');
            counter.className = 'text-xs text-gray-500';
            const updateCounter = () => { counter.textContent = `${textarea.value.length}/1000`; };
            updateCounter();
            textarea.addEventListener('input', updateCounter);

            const buttons = document.createElement('div');
            buttons.className = 'space-x-2';

            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'px-3 py-1 rounded border text-gray-700 hover:bg-gray-50';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', () => {
                if(originalPara) editor.replaceWith(originalPara);
                else editor.remove(); // No original text, just remove editor
            });

            const saveBtn = document.createElement('button');
            saveBtn.type = 'button';
            saveBtn.className = 'px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700';
            saveBtn.textContent = 'Save';
            saveBtn.addEventListener('click', async () => {
                const newText = textarea.value.trim();
                
                // Check if there's an image
                const hasImage = !!articleEl.querySelector('img[alt="Post image"]');
                if (!newText && !hasImage) { alert('Post cannot be empty.'); return; }
                if (newText.length > 1000) { alert('Post is too long (max 1000 chars).'); return; }

                saveBtn.disabled = true;
                try {
                    const postRef = doc(db, 'posts', postId);
                    await updateDoc(postRef, { text: newText, edited: true, editedAt: serverTimestamp() });

                    // Update UI
                    if(originalPara) {
                        originalPara.textContent = newText;
                        editor.replaceWith(originalPara);
                    } else if (newText) {
                        // We're adding text where there was none
                        const newPara = document.createElement('p');
                        newPara.className = 'mt-4 text-gray-700 text-lg whitespace-pre-wrap';
                        newPara.textContent = newText;
                        editor.replaceWith(newPara);
                    } else {
                        // We saved an empty text (but image exists)
                        editor.remove();
                    }
                    
                    const meta = articleEl.querySelector('[data-role="post-meta"]');
                    if (meta && !meta.querySelector('[data-badge="edited"]')) {
                        const editedBadge = document.createElement('span');
                        editedBadge.className = 'text-xs text-gray-400 border border-gray-200 rounded px-1';
                        editedBadge.setAttribute('data-badge', 'edited');
                        editedBadge.textContent = 'Edited';
                        meta.appendChild(editedBadge);
                    }
                } catch (e) {
                    console.error('Edit post failed', e);
                    alert(`Error saving changes: ${e.message}`);
                } finally {
                    saveBtn.disabled = false;
                }
            });

            buttons.appendChild(cancelBtn);
            buttons.appendChild(saveBtn);
            controls.appendChild(counter);
            controls.appendChild(buttons);

            editor.appendChild(textarea);
            editor.appendChild(controls);

            if(originalPara) {
                originalPara.replaceWith(editor);
            } else {
                // No text, insert editor after header
                articleEl.querySelector('div.flex').after(editor);
            }
            textarea.focus();
        }

        async function deletePost(articleEl, postId, imageUrl) { // NEW: Accept imageUrl
            if (!currentUser) return;
            // Use a custom modal/confirm later
            const confirmed = window.confirm('Are you sure you want to delete this post? This cannot be undone.');
            if (!confirmed) return;

            const previousClass = articleEl.className;
            articleEl.className += ' opacity-50 pointer-events-none';

            try {
                // Delete Firestore document
                await deleteDoc(doc(db, 'posts', postId));

                // NEW: Delete image from Storage if it exists
                if (imageUrl) {
                    try {
                        const imageRef = ref(storage, imageUrl);
                        // await deleteObject(imageRef); // Deleting by URL is tricky, need path.
                        // For simplicity, we'll leave the image. A server function would clean orphans.
                        // console.log("Storage object deletion skipped (requires path, not URL).");
                    } catch (storageError) {
                        console.warn("Error deleting storage object:", storageError);
                    }
                }

                const allInstances = document.querySelectorAll(`article[data-post-id="${postId}"]`);
                allInstances.forEach(el => el.remove());
            } catch (e) {
                console.error('Delete post failed', e);
                articleEl.className = previousClass;
                alert(`Error deleting post: ${e.message}`);
            }
        }


        // --- 9. LIKE & COMMENT FUNCTIONS ---

        async function loadUserLikedPosts(userId) {
            currentUserLikedPosts.clear();
            const q = query(collection(db, "users", userId, "likedPosts"));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => {
                currentUserLikedPosts.add(doc.id);
            });
        }

        async function toggleLike(postId, isLiked) {
            if (!currentUser) return;
            if (likeOpsInFlight.has(postId)) return;
            likeOpsInFlight.add(postId);
            
            updateLikeUI(postId, !isLiked);
            if (isLiked) {
                currentUserLikedPosts.delete(postId);
            } else {
                currentUserLikedPosts.add(postId);
            }

            const postRef = doc(db, "posts", postId);
            const userLikeRef = doc(db, "users", currentUser.uid, "likedPosts", postId);
            const postLikeRef = doc(db, "posts", postId, "likes", currentUser.uid);

            const batch = writeBatch(db);
            
            if (isLiked) {
                batch.delete(userLikeRef);
                batch.delete(postLikeRef);
                batch.update(postRef, { 
                    likeCount: increment(-1),
                    popularityScore: increment(-1)
                });
            } else {
                batch.set(userLikeRef, { likedAt: serverTimestamp() });
                batch.set(postLikeRef, { 
                    userId: currentUser.uid, 
                    username: currentUserProfile.username, 
                    likedAt: serverTimestamp() 
                });
                batch.update(postRef, { 
                    likeCount: increment(1),
                    popularityScore: increment(1)
                });
            }

            try {
                await batch.commit();
                if (!isLiked) {
                    try {
                        const postSnap = await getDoc(postRef);
                        const data = postSnap.data();
                        const ownerId = data?.userId;
                        if (ownerId && ownerId !== currentUser.uid) {
                            const preview = (data?.text || '').slice(0, 140);
                            await createNotification(ownerId, {
                                type: 'like',
                                fromUserId: currentUser.uid,
                                fromUsername: currentUserProfile.username,
                                fromPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile URL
                                targetId: postId,
                                targetText: preview
                            });
                        }
                    } catch (_) { /* best-effort */ }
                }
            } catch (error) {
                console.error("Error toggling like:", error);
                updateLikeUI(postId, isLiked);
                if (isLiked) {
                    currentUserLikedPosts.add(postId);
                } else {
                    currentUserLikedPosts.delete(postId);
                }
            } finally { likeOpsInFlight.delete(postId); }
        }
        
        function updateLikeUI(postId, isLiked) {
            const postElements = document.querySelectorAll(`article[data-post-id="${postId}"]`);
            postElements.forEach(postElement => {
                const likeBtn = postElement.querySelector('button[aria-label="Like post"]');
                const likeCountEl = postElement.querySelector('.like-count');
                if (!likeBtn || !likeCountEl) return;
                
                const currentCount = parseInt(likeCountEl.textContent);

                if (isLiked) {
                    likeBtn.classList.add('liked-button');
                    likeCountEl.textContent = currentCount + 1;
                } else {
                    likeBtn.classList.remove('liked-button');
                    likeCountEl.textContent = currentCount - 1;
                }
            });
        }
        
        async function toggleCommentSection(postId) {
            const commentSection = document.getElementById(`comments-section-${postId}`);
            if (commentSection) {
                const isHidden = commentSection.classList.toggle('hidden');
                if (!isHidden) {
                    await loadCommentsOnce(postId);
                    commentSection.querySelector('input[name="commentText"]').focus();
                }
            }
        }
        
        async function loadCommentsOnce(postId) {
            const listElement = document.getElementById(`comments-list-${postId}`);
            if (!listElement || listElement.dataset.loaded === 'true') {
                return;
            }

            listElement.innerHTML = '<p class="text-gray-500 text-sm">Loading comments...</p>';
            listElement.dataset.loaded = 'true';

            const q = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"), limit(50));
            const snapshot = await getDocs(q);

            listElement.innerHTML = '';
            if (snapshot.empty) {
                listElement.innerHTML = '<p class="text-gray-500 text-sm text-center">No comments yet.</p>';
            } else {
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    data.id = docSnap.id;
                    listElement.appendChild(createCommentElement(data));
                });
            }
        }
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3';
            
            // NEW: Use comment's photoURL
            const avatarUrl = comment.userPhotoURL || `https://placehold.co/36x36/E0E7FF/4F46E5?text=${comment.username.charAt(0).toUpperCase()}`;
            const avatar = document.createElement('img');
            avatar.src = avatarUrl;
            avatar.className = 'w-9 h-9 rounded-full cursor-pointer';
            avatar.onclick = () => showProfile(comment.userId);
            
            const content = document.createElement('div');
            content.className = 'flex-1 bg-slate-100 rounded-lg p-3';
            
            const name = document.createElement('p');
            name.className = 'text-sm font-semibold text-gray-800 cursor-pointer hover:underline';
            name.textContent = comment.username;
            name.onclick = () => showProfile(comment.userId);

            const text = document.createElement('p');
            text.className = 'text-sm text-gray-700';
            text.textContent = comment.text;

            if (comment.edited) {
                const edited = document.createElement('span');
                edited.className = 'ml-2 text-[10px] text-gray-500 border border-gray-200 rounded px-1 align-middle';
                edited.textContent = 'Edited';
                text.appendChild(edited);
            }

            if (currentUser && comment.userId === currentUser.uid) {
                const actions = document.createElement('div');
                actions.className = 'mt-2 flex space-x-2';
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'text-xs text-gray-500 hover:text-indigo-600';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => enterCommentEditMode(content, comment));

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'text-xs text-gray-500 hover:text-red-600';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', async () => {
                    // This is a minimal implementation
                    alert('Comment deletion not fully implemented in this demo.');
                });
                actions.appendChild(editBtn);
                content.appendChild(actions);
            }
            
            content.appendChild(name);
            content.appendChild(text);
            div.appendChild(avatar);
            div.appendChild(content);
            return div;
        }

        function enterCommentEditMode(contentEl, comment) {
            const existingTextP = Array.from(contentEl.children).find(c => c.tagName === 'P' && c.className.includes('text-sm'));
            if (!existingTextP) return;
            const original = existingTextP.textContent || '';
            const editor = document.createElement('div');
            editor.className = 'mt-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.value = original;
            input.maxLength = 500;
            input.className = 'w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400';
            const controls = document.createElement('div');
            controls.className = 'mt-2 flex justify-end space-x-2';
            const cancel = document.createElement('button');
            cancel.type = 'button';
            cancel.className = 'px-3 py-1 rounded border text-gray-700 hover:bg-gray-50';
            cancel.textContent = 'Cancel';
            cancel.onclick = () => { editor.replaceWith(existingTextP); };
            const save = document.createElement('button');
            save.type = 'button';
            save.className = 'px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700';
            save.textContent = 'Save';
            save.onclick = async () => {
                const newText = input.value.trim();
                if (!newText) { alert('Comment cannot be empty.'); return; }
                try {
                    const postId = contentEl.closest('article')?.dataset?.postId;
                    if (!postId || !comment || !comment.id) { alert('Cannot edit this comment.'); return; }
                    const ref = doc(db, 'posts', postId, 'comments', comment.id);
                    await updateDoc(ref, { text: newText, edited: true, editedAt: serverTimestamp() });
                    existingTextP.textContent = newText;
                    const editedBadge = document.createElement('span');
                    editedBadge.className = 'ml-2 text-[10px] text-gray-500 border border-gray-200 rounded px-1 align-middle';
                    editedBadge.textContent = 'Edited';
                    existingTextP.appendChild(editedBadge);
                    editor.replaceWith(existingTextP);
                } catch (e) {
                    alert(`Error saving comment: ${e.message}`);
                }
            };
            controls.appendChild(cancel);
            controls.appendChild(save);
            editor.appendChild(input);
            editor.appendChild(controls);
            existingTextP.replaceWith(editor);
            input.focus();
        }
        
        async function handleCommentSubmit(e, postId) {
            e.preventDefault();
            if (!currentUser) return;
            
            const form = e.target;
            const input = form.commentText;
            const text = input.value.trim();
            
            if (!text) return;
            
            form.querySelector('button[type="submit"]').disabled = true;

            const newComment = {
                text: text,
                userId: currentUser.uid,
                username: currentUserProfile.username,
                userPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile URL
                createdAt: serverTimestamp()
            };

            const postRef = doc(db, "posts", postId);
            const newCommentRef = doc(collection(db, "posts", postId, "comments"));
            const batch = writeBatch(db);

            try {
                batch.set(newCommentRef, newComment);
                batch.update(postRef, { 
                    commentCount: increment(1),
                    popularityScore: increment(3)
                });
                await batch.commit();

                const listElement = document.getElementById(`comments-list-${postId}`);
                if (listElement.dataset.loaded === 'true') {
                    const noComments = listElement.querySelector('p.text-center');
                    if (noComments) noComments.remove();
                    
                    listElement.appendChild(createCommentElement({
                        ...newComment,
                        createdAt: { toDate: () => new Date() }
                    }));
                    listElement.scrollTop = listElement.scrollHeight;
                }
                
                const postElements = document.querySelectorAll(`article[data-post-id="${postId}"]`);
                postElements.forEach(postElement => {
                    const countEl = postElement.querySelector('.comment-count');
                    if(countEl) {
                        countEl.textContent = parseInt(countEl.textContent) + 1;
                    }
                });
                
                input.value = '';

                try {
                    const postRef = doc(db, 'posts', postId);
                    const postSnap = await getDoc(postRef);
                    const data = postSnap.data();
                    const ownerId = data?.userId;
                    if (ownerId && ownerId !== currentUser.uid) {
                        const preview = text.slice(0, 140);
                        await createNotification(ownerId, {
                            type: 'comment',
                            fromUserId: currentUser.uid,
                            fromUsername: currentUserProfile.username,
                            fromPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile URL
                            targetId: postId,
                            targetText: preview
                        });
                    }
                } catch (_) { /* best-effort */ }
                
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Error adding comment. Please try again.");
            }
            form.querySelector('button[type="submit"]').disabled = false;
        }

        // --- 10. PROFILE & FOLLOWING FUNCTIONS ---
        
        // NEW: Avatar Upload Handler
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/') || !currentUser) return;
            
            if (file.size > 2 * 1024 * 1024) { // 2MB limit for avatars
                avatarUploadStatus.textContent = 'File is too large (Max 2MB).';
                settingsAvatarStatus.textContent = 'File is too large (Max 2MB).';
                return;
            }
            
            avatarUploadStatus.textContent = 'Uploading...';
            settingsAvatarStatus.textContent = 'Uploading...';
            
            try {
                const path = `avatars/${currentUser.uid}/profile.jpg`;
                const newUrl = await uploadImage(file, path);
                
                // Update Auth profile
                await updateProfile(auth.currentUser, { photoURL: newUrl });
                
                // Update Firestore profile
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { photoURL: newUrl });
                
                // Update local state
                currentUserProfile.photoURL = newUrl;
                
                // Update UI
                updateAllAvatars(newUrl);
                
                avatarUploadStatus.textContent = 'Avatar updated!';
                settingsAvatarStatus.textContent = 'Avatar updated!';
                setTimeout(() => {
                    avatarUploadStatus.textContent = '';
                    settingsAvatarStatus.textContent = 'Click image to change';
                }, 3000);

            } catch (error) {
                console.error("Avatar Upload Error:", error);
                avatarUploadStatus.textContent = 'Upload failed. Try again.';
                settingsAvatarStatus.textContent = 'Upload failed. Try again.';
            } finally {
                // Clear file input value to allow re-uploading the same file
                avatarFileInput.value = '';
                settingsAvatarInput.value = '';
            }
        }

        async function showProfile(userId) {
            profileLastVisible = null; 
            isLoadingProfile = false;
            
            navigateTo("content-profile");
            
            const currentFollowButton = document.getElementById('profile-follow-button');
            profileUsername.textContent = 'Loading...';
            profileHandle.textContent = '...';
            profileFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Loading posts...</p>';
            currentFollowButton.classList.add('hidden');
            avatarUploadStatus.textContent = ''; // Clear status

            // NEW: Show/hide avatar upload overlay
            if (userId === currentUser.uid) {
                avatarChangeOverlay.classList.remove('hidden');
            } else {
                avatarChangeOverlay.classList.add('hidden');
            }

            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                profileUsername.textContent = 'User not found';
                profileHandle.textContent = '';
                profileFeedContainer.innerHTML = '';
                return;
            }

            const profile = userSnap.data();
            
            profileUsername.textContent = profile.username;
            profileHandle.textContent = `@${profile.username}`;
            profileUid.textContent = profile.uid;
            // NEW: Use profile photoURL
            profileAvatar.src = profile.photoURL || `https://placehold.co/80x80/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            profileFollowingCount.textContent = profile.followingCount || 0;
            profileFollowersCount.textContent = profile.followersCount || 0;

            if (userId === currentUser.uid) {
                currentFollowButton.classList.add('hidden');
                if (profileMessageButton) profileMessageButton.classList.add('hidden');
            } else {
                currentFollowButton.classList.remove('hidden');
                if (!profileMessageButton) {
                    profileMessageButton = document.createElement('button');
                    profileMessageButton.id = 'profile-message-button';
                    profileMessageButton.className = 'mt-4 sm:mt-0 w-full sm:w-auto border border-gray-300 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-50 transition duration-200 sm:ml-3';
                    profileMessageButton.innerHTML = '<span class="inline-flex items-center space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><span>Message</span></span>';
                    profileFollowButton.parentNode.insertBefore(profileMessageButton, profileFollowButton.nextSibling);
                }
                profileMessageButton.classList.remove('hidden');
                const followRef = doc(db, "users", currentUser.uid, "following", userId);
                const followSnap = await getDoc(followRef);
                
                if (followSnap.exists()) {
                    currentFollowButton.textContent = 'Unfollow';
                    currentFollowButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.add('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'true';
                } else {
                    currentFollowButton.textContent = 'Follow';
                    currentFollowButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'false';
                }
                
                const newFollowBtn = currentFollowButton.cloneNode(true);
                currentFollowButton.parentNode.replaceChild(newFollowBtn, currentFollowButton);
                
                newFollowBtn.addEventListener('click', () => {
                    const isFollowing = newFollowBtn.dataset.following === 'true';
                    if (isFollowing) {
                        unfollowUser(userId, profile.username, newFollowBtn); 
                    } else {
                        followUser(userId, profile.username, newFollowBtn);
                    }
                });

                profileMessageButton.onclick = () => startConversation(userId, profile.username);
            }
            
            loadProfileFeed(userId, false);
        }

        async function startConversation(targetUserId, targetUsername) {
            if (!currentUser) return;
            const convoId = [currentUser.uid, targetUserId].sort().join('_');
            const convoDocRef = doc(db, 'conversations', convoId);
            try {
                // NEW: Get target user's photoURL
                const targetUserRef = doc(db, 'users', targetUserId);
                const targetUserSnap = await getDoc(targetUserRef);
                const targetUserPhoto = targetUserSnap.data()?.photoURL || '';

                await setDoc(convoDocRef, {
                    members: [currentUser.uid, targetUserId],
                    memberInfo: {
                        [currentUser.uid]: { username: currentUserProfile.username, photoURL: currentUserProfile.photoURL || '' },
                        [targetUserId]: { username: targetUsername, photoURL: targetUserPhoto }
                    },
                    lastMessage: '',
                    lastMessageAt: serverTimestamp(),
                    lastMessageSenderId: ''
                }, { merge: true });
                navigateTo('content-messages');
                openConversation(targetUserId, targetUsername);
                dmInput?.focus();
            } catch (e) {
                console.error('Failed to start conversation', e);
                alert('Unable to start conversation. Please try again.');
            }
        }

        async function followUser(targetUserId, targetUsername, button) {
            button.disabled = true;
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.set(followingRef, {
                username: targetUsername,
                followedAt: serverTimestamp()
            });
            batch.set(followerRef, {
                username: currentUserProfile.username,
                followedAt: serverTimestamp()
            });
            
            batch.update(currentUserRef, { followingCount: increment(1) });
            batch.update(targetUserRef, { followersCount: increment(1) });
            
            try {
                await batch.commit();
                button.textContent = 'Unfollow';
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'true';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) + 1;
                homeLastVisible = null; 
                try {
                    if (targetUserId !== currentUser.uid) {
                        await createNotification(targetUserId, {
                            type: 'follow',
                            fromUserId: currentUser.uid,
                            fromUsername: currentUserProfile.username,
                            fromPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile URL
                            targetId: targetUserId,
                            targetText: ''
                        });
                    }
                } catch (_) { /* best-effort */ }
            } catch (error) {
                console.error("Error following user:", error);
            }
            button.disabled = false;
        }
        
        async function unfollowUser(targetUserId, targetUsername, button) {
            button.disabled = true;
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.delete(followingRef);
            batch.delete(followerRef);
            batch.update(currentUserRef, { followingCount: increment(-1) });
            batch.update(targetUserRef, { followersCount: increment(-1) });

            try {
                await batch.commit();
                button.textContent = 'Follow';
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'false';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) - 1;
                homeLastVisible = null;
            } catch (error) {
                console.error("Error unfollowing user:", error);
            }
            button.disabled = false;
        }

        // --- 11. DIRECT MESSAGES ---
        
        dmBackButton.addEventListener('click', () => {
            dmContentPanel.classList.remove('mobile-chat-view');
            dmContentPanel.classList.add('mobile-chat-list');
            resetChatView();
        });

        function resetChatView() {
            dmChatView.classList.add('hidden');
            dmChatPlaceholder.classList.remove('hidden');
            dmChatHeader.textContent = 'Select a conversation';
            dmInput.disabled = true;
            dmFormButton.disabled = true;
            dmInput.placeholder = 'Select a conversation to message...';
            messageLog.innerHTML = '';
            currentChatPartner = null;
            if (unsubscribeConversation) unsubscribeConversation();
            unsubscribeConversation = null;
        }

        async function loadConversationList() {
            if (!currentUser) return;

            dmConversationList.innerHTML = '<p class="p-4 text-gray-500">Loading conversations...</p>';

            try {
                const convosQ = query(
                    collection(db, "conversations"),
                    where("members", "array-contains", currentUser.uid),
                    orderBy("lastMessageAt", "desc"),
                    limit(50)
                );
                
                // Use onSnapshot to get realtime updates for convo list
                onSnapshot(convosQ, (convSnap) => {
                    if (convSnap.empty) {
                        dmConversationList.innerHTML = '<p class="p-4 text-gray-500">No conversations yet. Start one from a user profile.</p>';
                        return;
                    }

                    dmConversationList.innerHTML = '';
                    convSnap.forEach(c => {
                        const data = c.data();
                        const otherId = data.members.find(m => m !== currentUser.uid) || '';
                        const otherInfo = data.memberInfo ? data.memberInfo[otherId] : {};
                        const otherUsername = otherInfo?.username || 'Unknown';
                        const otherPhoto = otherInfo?.photoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${otherUsername.charAt(0).toUpperCase()}`;

                        const el = document.createElement('div');
                        el.className = "flex items-center p-4 border-b border-gray-200 cursor-pointer hover:bg-slate-100";
                        el.dataset.userId = otherId;
                        el.dataset.username = otherUsername;
                        
                        const img = document.createElement('img');
                        img.src = otherPhoto;
                        img.className = 'w-10 h-10 rounded-full mr-3';
                        el.appendChild(img);
                        
                        const textDiv = document.createElement('div');
                        const nameP = document.createElement('p');
                        nameP.className = 'font-semibold text-gray-800';
                        nameP.textContent = otherUsername;
                        textDiv.appendChild(nameP);
                        
                        // Show last message preview
                        if (data.lastMessage) {
                            const lastMsgP = document.createElement('p');
                            lastMsgP.className = 'text-sm text-gray-500 truncate';
                            let prefix = (data.lastMessageSenderId === currentUser.uid) ? 'You: ' : '';
                            lastMsgP.textContent = `${prefix}${data.lastMessage}`;
                            textDiv.appendChild(lastMsgP);
                        }
                        
                        el.appendChild(textDiv);
                        
                        // Highlight currently selected chat
                        if (currentChatPartner?.uid === otherId) {
                            el.classList.add('bg-indigo-100', 'font-semibold');
                        }

                        el.onclick = () => {
                            Array.from(dmConversationList.children).forEach(child => child.classList.remove('bg-indigo-100', 'font-semibold'));
                            el.classList.add('bg-indigo-100', 'font-semibold');
                            openConversation(otherId, otherUsername);
                        };
                        dmConversationList.appendChild(el);
                    });
                }, (e) => {
                     console.error('Error loading conversations list', e);
                    dmConversationList.innerHTML = '<p class="p-4 text-red-500">Error loading conversations.</p>';
                });

            } catch (e) {
                console.error('Error setting up conversation listener', e);
                dmConversationList.innerHTML = '<p class="p-4 text-red-500">Error loading conversations.</p>';
            }
        }

        async function openConversation(partnerId, partnerUsername) {
            currentChatPartner = { uid: partnerId, username: partnerUsername };
            
            dmContentPanel.classList.remove('mobile-chat-list');
            dmContentPanel.classList.add('mobile-chat-view');

            dmChatView.classList.remove('hidden');
            dmChatPlaceholder.classList.add('hidden');
            dmChatHeader.textContent = `Chat with ${partnerUsername}`;
            dmInput.disabled = false;
            dmFormButton.disabled = false;
            dmInput.placeholder = `Message ${partnerUsername}...`;
            
            const convoId = [currentUser.uid, partnerId].sort().join('_');
            const convoDocRef = doc(db, "conversations", convoId);
            
            try {
                // This logic is now in startConversation, but we can merge it here
                // to ensure the partner's info is up-to-date
                const targetUserRef = doc(db, 'users', partnerId);
                const targetUserSnap = await getDoc(targetUserRef);
                const targetUserPhoto = targetUserSnap.data()?.photoURL || '';

                await setDoc(convoDocRef, {
                    members: [currentUser.uid, partnerId],
                    memberInfo: {
                        [currentUser.uid]: { username: currentUserProfile.username, photoURL: currentUserProfile.photoURL || '' },
                        [partnerId]: { username: partnerUsername, photoURL: targetUserPhoto }
                    }
                }, { merge: true });
                
                loadConversationMessages(convoId);
            } catch (error) {
                console.error("Error ensuring conversation exists:", error);
                messageLog.innerHTML = '<p class="text-red-500 text-center">Could not open conversation.</p>';
            }
        }

        function loadConversationMessages(convoId) {
            if (unsubscribeConversation) unsubscribeConversation();

            const q = query(collection(db, "conversations", convoId, "messages"), orderBy("createdAt", "asc"), limit(100));
            
            unsubscribeConversation = onSnapshot(q, (snapshot) => {
                messageLog.innerHTML = '';
                if (snapshot.empty) {
                    messageLog.innerHTML = '<p class="text-gray-500 text-center p-4">No messages yet. Say hi!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const msgElement = document.createElement('div');
                    
                    const text = document.createElement('p');
                    text.textContent = msg.text;
                    msgElement.appendChild(text);

                    if (msg.senderId === currentUser.uid) {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-indigo-600 text-white ml-auto";
                    } else {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-slate-200 text-gray-800 mr-auto";
                    }
                    
                    messageLog.appendChild(msgElement);
                });
                messageLog.scrollTop = messageLog.scrollHeight;
            }, (error) => {
                console.error("Error loading messages:", error);
                messageLog.innerHTML = '<p class="text-red-500 text-center">Error loading messages.</p>';
            });
        }

        dmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = dmInput.value.trim();
            
            if (!text || !currentUser || !currentChatPartner) return;
            
            const tempMessage = dmInput.value;
            dmInput.value = '';
            dmFormButton.disabled = true;
            
            const convoId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const convoDocRef = doc(db, "conversations", convoId);
            const messagesColRef = collection(convoDocRef, "messages");

            try {
                // Add message to subcollection
                const msgPromise = addDoc(messagesColRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderUsername: currentUserProfile.username,
                    createdAt: serverTimestamp()
                });
                
                // Update parent doc
                const convoPromise = updateDoc(convoDocRef, {
                    lastMessage: text,
                    lastMessageAt: serverTimestamp(),
                    lastMessageSenderId: currentUser.uid
                });
                
                await Promise.all([msgPromise, convoPromise]);

                dmFormButton.disabled = false;
                dmInput.focus();
                
                try {
                    if (currentChatPartner?.uid && currentChatPartner.uid !== currentUser.uid) {
                        await createNotification(currentChatPartner.uid, {
                            type: 'message',
                            fromUserId: currentUser.uid,
                            fromUsername: currentUserProfile.username,
                            fromPhotoURL: currentUserProfile.photoURL || '', // NEW: Use profile URL
                            targetId: convoId,
                            targetText: text.slice(0, 140)
                        });
                    }
                } catch (_) { /* best-effort */ }
                
            } catch (error) {
                console.error("DM Send Error:", error);
                alert(`Error sending message: ${error.message}`);
                dmInput.value = tempMessage;
                dmFormButton.disabled = false;
            }
        });

        // --- 12. APP NAVIGATION (TABS) ---
        
        const navLinks = document.querySelectorAll('.nav-link');
        const bottomNavLinks = document.querySelectorAll('.bottom-nav-link'); 
        const bottomNav = document.getElementById('bottom-nav');
        const contentPanels = document.querySelectorAll('.content-panel');
        const sidebarPostButton = document.getElementById('sidebar-post-button');
        
        // --- 12.1 NOTIFICATIONS HELPERS ---
        function updateNotifBadge(count) {
            const setBadge = (el) => {
                if (!el) return;
                if (count > 0) { el.classList.remove('hidden'); el.textContent = String(count); }
                else { el.classList.add('hidden'); el.textContent = '0'; }
            };
            setBadge(notifBadgeDesktop);
            setBadge(notifBadgeMobile);
        }

        async function createNotification(targetUserId, { type, fromUserId, fromUsername, fromPhotoURL, targetId, targetText }) {
            try {
                const colRef = collection(db, 'users', targetUserId, 'notifications');
                await addDoc(colRef, {
                    type,
                    fromUserId,
                    fromUsername,
                    fromPhotoURL, // Already using the correct profile URL
                    targetId,
                    targetText,
                    read: false,
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                // best-effort; swallow
            }
        }

        function renderNotificationItem(id, n) {
            const row = document.createElement('div');
            row.className = `flex items-start p-3 ${n.read ? '' : 'bg-indigo-50'}`;
            row.dataset.id = id;
            // NEW: Use fromPhotoURL
            const avatar = document.createElement('img');
            avatar.src = n.fromPhotoURL || `https://placehold.co/36x36/E0E7FF/4F46E5?text=${(n.fromUsername||'?').charAt(0).toUpperCase()}`;
            avatar.className = 'w-9 h-9 rounded-full mr-3';
            
            const body = document.createElement('div');
            body.className = 'flex-1';
            const title = document.createElement('p');
            title.className = 'text-sm text-gray-800';
            let action = 'did something';
            if (n.type === 'like') action = 'liked your post';
            else if (n.type === 'comment') action = 'commented on your post';
            else if (n.type === 'follow') action = 'followed you';
            else if (n.type === 'message') action = 'sent you a message';
            title.textContent = `@${n.fromUsername} ${action}`;
            const preview = document.createElement('p');
            preview.className = 'text-xs text-gray-500 truncate';
            preview.textContent = n.targetText || '';
            body.appendChild(title);
            if (n.targetText) body.appendChild(preview);
            row.appendChild(avatar);
            row.appendChild(body);

            row.addEventListener('click', async () => {
                try {
                    await markNotificationAsRead(id);
                } catch (_) {}
                if (n.type === 'like' || n.type === 'comment') {
                    navigateTo('content-discover');
                } else if (n.type === 'follow') {
                    showProfile(n.fromUserId);
                } else if (n.type === 'message') {
                    navigateTo('content-messages');
                    openConversation(n.fromUserId, n.fromUsername);
                }
            });

            return row;
        }

        function startNotificationsListener(userId) {
            if (unsubscribeNotifications) { unsubscribeNotifications(); unsubscribeNotifications = null; }
            const q = query(collection(db, 'users', userId, 'notifications'), orderBy('createdAt', 'desc'), limit(50));
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                if (!notifList) return;
                notifList.innerHTML = '';
                if (snap.empty) {
                    notifList.innerHTML = '<p class="text-gray-500">No notifications yet.</p>';
                    updateNotifBadge(0);
                    return;
                }
                let unread = 0;
                snap.forEach(d => {
                    const n = d.data();
                    if (!n.read) unread += 1;
                    notifList.appendChild(renderNotificationItem(d.id, n));
                });
                updateNotifBadge(unread);
            }, (_) => {
                // ignore errors for UI
            });
        }

        async function markNotificationAsRead(id) {
            if (!currentUser) return;
            const ref = doc(db, 'users', currentUser.uid, 'notifications', id);
            try { await updateDoc(ref, { read: true }); } catch (_) {}
        }

        async function markAllNotificationsAsRead() {
            if (!currentUser) return;
            try {
                const q = query(collection(db, 'users', currentUser.uid, 'notifications'), where('read', '==', false), limit(200));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => batch.update(d.ref, { read: true }));
                await batch.commit();
            } catch (_) {}
        }

        // --- 12.2 SEARCH FUNCTIONS ---
        function setSearchTab(tab) {
            searchActiveTab = tab;
            if (tab === 'users') {
                searchTabUsers.classList.add('bg-indigo-600','text-white');
                searchTabPosts.classList.remove('bg-indigo-600','text-white');
            } else {
                searchTabPosts.classList.add('bg-indigo-600','text-white');
                searchTabUsers.classList.remove('bg-indigo-600','text-white');
            }
            runSearch();
        }

        function debounce(fn, delay) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        }

        const runSearch = debounce(async () => {
            const termRaw = (searchInput?.value || '').trim();
            if (!searchResults) return;
            if (!termRaw) { searchResults.innerHTML = '<p class="text-gray-500">Type to search.</p>'; return; }
            const term = termRaw.toLowerCase();
            searchResults.innerHTML = '<p class="text-gray-500">Searching...</p>';

            try {
                if (searchActiveTab === 'users') {
                    const lower = term;
                    const upper = term + '\uf8ff';
                    const qUsers = query(collection(db, 'users'), where('username','>=', lower), where('username','<=', upper), orderBy('username', 'asc'), limit(20));
                    const snap = await getDocs(qUsers);
                    if (snap.empty) { searchResults.innerHTML = '<p class="text-gray-500">No users found.</p>'; return; }
                    const frag = document.createDocumentFragment();
                    snap.forEach(d => {
                        const u = d.data();
                        const row = document.createElement('div');
                        row.className = 'flex items-center p-3 border rounded hover:bg-slate-50 cursor-pointer';
                        // NEW: Use user photoURL
                        const avatar = document.createElement('img');
                        avatar.src = u.photoURL || `https://placehold.co/36x36/E0E7FF/4F46E5?text=${(u.username||'?').charAt(0).toUpperCase()}`;
                        avatar.className = 'w-9 h-9 rounded-full mr-3';
                        const body = document.createElement('div');
                        const name = document.createElement('p');
                        name.className = 'font-medium text-gray-800';
                        name.textContent = u.username;
                        const meta = document.createElement('p');
                        meta.className = 'text-xs text-gray-500';
                        meta.textContent = `${u.followersCount || 0} followers`;
                        body.appendChild(name); body.appendChild(meta);
                        row.appendChild(avatar); row.appendChild(body);
                        row.addEventListener('click', () => showProfile(u.uid));
                        frag.appendChild(row);
                    });
                    searchResults.innerHTML = '';
                    searchResults.appendChild(frag);
                } else {
                    const qPosts = query(collection(db, 'posts'), orderBy('createdAt','desc'), limit(100));
                    const snap = await getDocs(qPosts);
                    const matches = [];
                    snap.forEach(d => {
                        const p = d.data();
                        const text = (p.text || '').toLowerCase();
                        if (text.includes(term)) matches.push({ id: d.id, p });
                    });
                    if (!matches.length) { searchResults.innerHTML = '<p class="text-gray-500">No posts found.</p>'; return; }
                    const frag = document.createDocumentFragment();
                    matches.slice(0,20).forEach(({id, p}) => frag.appendChild(createPostElement(id, p)));
                    searchResults.innerHTML = '';
                    searchResults.appendChild(frag);
                }
            } catch (e) {
                console.error('Search error', e);
                let errorMsg = `Error searching. ${e.message}`;
                if (e.message && e.message.toLowerCase().includes("index")) {
                    errorMsg = `Search failed: ${e.message}. You may need to create a Firestore index. Check the browser console (F12) for a link to create it.`;
                }
                searchResults.innerHTML = `<p class="text-red-500">${errorMsg}</p>`;
            }
        }, 400);

        function navigateTo(targetId) {
            navLinks.forEach(nav => {
                if (nav.dataset.target === targetId) {
                    nav.classList.add('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.remove('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                } else {
                    nav.classList.remove('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.add('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                }
            });

            bottomNavLinks.forEach(nav => {
                if (nav.dataset.target === targetId) {
                    nav.classList.add('active');
                } else {
                    nav.classList.remove('active');
                }
            });

            contentPanels.forEach(panel => {
                if (panel.id === targetId) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            if (targetId === 'content-messages') {
                loadConversationList();
                resetChatView();
                dmContentPanel.classList.remove('mobile-chat-view');
                dmContentPanel.classList.add('mobile-chat-list');
            } else if (unsubscribeConversation) {
                unsubscribeConversation();
                unsubscribeConversation = null;
                currentChatPartner = null;
            }

            window.scrollTo(0, 0);
        }
        
        // --- 13. ACCOUNT DELETION ---

        async function deleteByQuery(q, { batchSize = 200, perDoc } = {}) {
            const snapshot = await getDocs(q);
            if (snapshot.empty) return 0;
            let deleted = 0;
            let batch = writeBatch(db);
            let ops = 0;
            for (const d of snapshot.docs) {
                if (perDoc) await perDoc(d, batch);
                else batch.delete(d.ref);
                ops += 1;
                deleted += 1;
                if (ops >= batchSize) {
                    await batch.commit();
                    batch = writeBatch(db);
                    ops = 0;
                }
            }
            if (ops > 0) await batch.commit();
            return deleted;
        }

        async function deleteCollection(path, { batchSize = 200 } = {}) {
            let total = 0;
            while (true) {
                const q = query(collection(db, path), limit(batchSize));
                const snapshot = await getDocs(q);
                if (snapshot.empty) break;
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
                total += snapshot.size;
                if (snapshot.size < batchSize) break;
            }
            return total;
        }

        async function deleteSubcollection(parentPath, subcollectionName) {
            return await deleteCollection(`${parentPath}/${subcollectionName}`);
        }

        async function deleteUserPostsAndSubcollections(userId) {
            const postsQ = query(collection(db, "posts"), where("userId", "==", userId), limit(100));
            const postsSnap = await getDocs(postsQ);
            if (postsSnap.empty) return;
            for (const postDoc of postsSnap.docs) {
                const postId = postDoc.id;
                const postPath = `posts/${postId}`;
                await deleteSubcollection(postPath, "comments");
                await deleteSubcollection(postPath, "likes");
                
                // NEW: Delete post image from Storage
                const postData = postDoc.data();
                if (postData.imageUrl) {
                    try {
                        // This is a best-effort delete, as we don't have the full path
                        // A cloud function is the robust way to handle this.
                    } catch (e) { console.warn('Could not delete post image', e.message); }
                }
                
                await deleteDoc(postDoc.ref);
            }
            if (postsSnap.size === 100) await deleteUserPostsAndSubcollections(userId);
        }

        async function removeUserLikedPostsAndAdjustCounters(userId) {
            const likedQ = query(collection(db, "users", userId, "likedPosts"), limit(200));
            const likedSnap = await getDocs(likedQ);
            if (likedSnap.empty) return;
            for (const liked of likedSnap.docs) {
                const postId = liked.id;
                const postRef = doc(db, "posts", postId);
                const postLikeRef = doc(db, "posts", postId, "likes", userId);
                const userLikeRef = doc(db, "users", userId, "likedPosts", postId);
                const batch = writeBatch(db);
                batch.delete(userLikeRef);
                batch.delete(postLikeRef);
                batch.update(postRef, { likeCount: increment(-1), popularityScore: increment(-1) });
                try { await batch.commit(); } catch (_) { /* ignore */ }
            }
            if (likedSnap.size === 200) await removeUserLikedPostsAndAdjustCounters(userId);
        }

        async function removeUserCommentsAndAdjustCounters(userId) {
            const commentsQ = query(collectionGroup(db, "comments"), where("userId", "==", userId), limit(200));
            const snap = await getDocs(commentsQ);
            if (snap.empty) return;
            for (const c of snap.docs) {
                const parentPostRef = c.ref.parent.parent;
                if (parentPostRef) {
                    const batch = writeBatch(db);
                    batch.delete(c.ref);
                    batch.update(parentPostRef, { commentCount: increment(-1), popularityScore: increment(-3) });
                    try { await batch.commit(); } catch (_) { /* ignore */ }
                } else {
                    try { await deleteDoc(c.ref); } catch (_) { /* ignore */ }
                }
            }
            if (snap.size === 200) await removeUserCommentsAndAdjustCounters(userId);
        }

        async function removeFollowGraphs(userId) {
            const followingQ = query(collection(db, "users", userId, "following"), limit(200));
            const followingSnap = await getDocs(followingQ);
            for (const f of followingSnap.docs) {
                const targetRef = doc(db, "users", f.id);
                try { await updateDoc(targetRef, { followersCount: increment(-1) }); } catch (_) {}
            }
            await deleteCollection(`users/${userId}/following`);

            const followersQ = query(collection(db, "users", userId, "followers"), limit(200));
            const followersSnap = await getDocs(followersQ);
            for (const f of followersSnap.docs) {
                const followerRef = doc(db, "users", f.id);
                try { await updateDoc(followerRef, { followingCount: increment(-1) }); } catch (_) {}
            }
            await deleteCollection(`users/${userId}/followers`);
        }

        async function scrubDirectMessagesForUser(userId) {
            const convosQ = query(collection(db, "conversations"), where("members", "array-contains", userId), limit(50));
            const convosSnap = await getDocs(convosQ);
            for (const convo of convosSnap.docs) {
                const convoId = convo.id;
                const msgsQ = query(collection(db, "conversations", convoId, "messages"), where("senderId", "==", userId), limit(200));
                await deleteByQuery(msgsQ);
                const data = convo.data();
                const updates = { 
                    [`memberInfo.${userId}`]: deleteField(),
                    [`memberInfo`]: {
                        ...data.memberInfo,
                        [userId]: deleteField()
                    }
                };
                if (data.lastMessageSenderId === userId) {
                    updates.lastMessage = "";
                    updates.lastMessageSenderId = "";
                    updates.lastMessageAt = serverTimestamp();
                }
                try { await updateDoc(convo.ref, updates); } catch (_) {}
            }
        }
        
        deleteAccountBtn.addEventListener('click', () => {
            deleteError.textContent = '';
            confirmDeleteBtn.disabled = false;
            reauthSection.classList.add('hidden');
            reauthPasswordContainer.classList.add('hidden');
            reauthGoogleBtn.classList.add('hidden');
            if (reauthPasswordInput) reauthPasswordInput.value = '';
            deleteAccountModal.classList.remove('hidden');
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteAccountModal.classList.add('hidden');
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            deleteUserAccount();
        });

        retryDeleteBtn.addEventListener('click', () => {
            deleteUserAccount();
        });

        function showReauthOptions() {
            if (!currentUser) return;
            reauthSection.classList.remove('hidden');
            const providers = (currentUser.providerData || []).map(p => p.providerId);
            if (providers.includes('password') || currentUser.email) {
                reauthPasswordContainer.classList.remove('hidden');
            } else {
                reauthPasswordContainer.classList.add('hidden');
            }
            if (providers.includes('google.com')) {
                reauthGoogleBtn.classList.remove('hidden');
            } else {
                reauthGoogleBtn.classList.add('hidden');
            }
        }

        reauthPasswordBtn?.addEventListener('click', async () => {
            if (!currentUser) return;
            const pwd = reauthPasswordInput.value.trim();
            if (!pwd || !currentUser.email) {
                deleteError.textContent = 'Enter your password to reauthenticate.';
                return;
            }
            try {
                const cred = EmailAuthProvider.credential(currentUser.email, pwd);
                await reauthenticateWithCredential(currentUser, cred);
                deleteError.textContent = 'Reauthentication successful. Retrying deletion...';
                await deleteUserAccount();
            } catch (e) {
                console.error('Password reauth failed', e);
                deleteError.textContent = `Reauthentication failed: ${e.message}`;
            }
        });

        reauthGoogleBtn?.addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                await reauthenticateWithPopup(currentUser, new GoogleAuthProvider());
                deleteError.textContent = 'Reauthentication successful. Retrying deletion...';
                await deleteUserAccount();
            } catch (e) {
                console.error('Google reauth failed', e);
                deleteError.textContent = `Reauthentication failed: ${e.message}`;
            }
        });
        
        async function deleteUserAccount() {
            const user = auth.currentUser;
            if (!user || !currentUserProfile) return;
            
            confirmDeleteBtn.disabled = true;
            deleteError.textContent = 'Deleting account... (1/6) Removing likes and comments';

            try {
                await removeUserLikedPostsAndAdjustCounters(user.uid);
                await removeUserCommentsAndAdjustCounters(user.uid);

                deleteError.textContent = 'Deleting account... (2/6) Deleting your posts';
                await deleteUserPostsAndSubcollections(user.uid);

                deleteError.textContent = 'Deleting account... (3/6) Cleaning your follow graph';
                await removeFollowGraphs(user.uid);

                deleteError.textContent = 'Deleting account... (4/6) Scrubbing your direct messages';
                await scrubDirectMessagesForUser(user.uid);
                
                // NEW: Delete avatar from Storage
                try {
                    const path = `avatars/${user.uid}/profile.jpg`;
                    const avatarRef = ref(storage, path);
                    // await deleteObject(avatarRef); // This can fail, but we try
                } catch (e) { console.warn('Could not delete avatar', e.message); }

                deleteError.textContent = 'Deleting account... (5/6) Removing profile';
                await deleteDoc(doc(db, "users", user.uid));
                await deleteDoc(doc(db, "usernames", currentUserProfile.username));

                deleteError.textContent = 'Deleting account... (6/6) Removing authentication record';
                await deleteUser(user);
                
                deleteAccountModal.classList.add('hidden');
                
            } catch (error) {
                console.error("Delete Account Error:", error);
                if (error.code === 'auth/requires-recent-login') {
                    deleteError.textContent = 'Sensitive action requires recent login. Please reauthenticate below.';
                    showReauthOptions();
                } else {
                    deleteError.textContent = `Error: ${error.message}`;
                }
                confirmDeleteBtn.disabled = false;
            }
        }
        
        // --- 14. EVENT LISTENERS (DOM LOADED) ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded. Attaching nav listeners.");

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    
                    if (targetId === 'content-profile') {
                        showProfile(currentUser.uid);
                    } else {
                        navigateTo(targetId);
                    }
                });
            });

            bottomNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    
                    if (targetId === 'content-profile') {
                        showProfile(currentUser.uid);
                    } else {
                        navigateTo(targetId);
                    }
                });
            });

            sidebarPostButton.addEventListener('click', () => {
                navigateTo('content-home');
                postTextarea.focus();
            });

            sidebarProfileButton.addEventListener('click', () => {
                showProfile(currentUser.uid);
            });
            
            homeLoadMoreBtn.addEventListener('click', () => {
                if(currentUser) loadFollowingFeed(currentUser.uid, true);
            });
            discoverLoadMoreBtn.addEventListener('click', () => {
                loadDiscoverFeed(true);
            });
            profileLoadMoreBtn.addEventListener('click', () => {
                const userId = profileUid.textContent;
                if(userId) loadProfileFeed(userId, true);
            });
            
            if (discoverFilterSelect) {
                discoverFilterSelect.value = currentDiscoverFilter;
                discoverFilterSelect.addEventListener('change', (e) => {
                    const selected = e.target.value;
                    if (!selected || selected === currentDiscoverFilter) return;
                    currentDiscoverFilter = selected;
                    loadDiscoverFeed(false);
                });
            }

            notifMarkAllBtn?.addEventListener('click', () => {
                markAllNotificationsAsRead();
            });

            searchTabUsers?.addEventListener('click', () => setSearchTab('users'));
            searchTabPosts?.addEventListener('click', () => setSearchTab('posts'));
            searchInput?.addEventListener('input', () => runSearch());
            searchClearBtn?.addEventListener('click', () => { if (searchInput) { searchInput.value = ''; runSearch(); } });

            // NEW: Avatar upload listeners
            avatarFileInput?.addEventListener('change', handleAvatarUpload);
            settingsAvatarInput?.addEventListener('change', handleAvatarUpload);

            attemptCanvasAuth();
        });

    </script>

    <script>
    // Fallback error display
    function showInlineError(msg, targetId) {
      const id = targetId || 'auth-error';
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
      } else {
        console.error('Error:', msg);
      }
    }
    </script>
</body>
</html>
